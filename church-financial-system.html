<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://apis.google.com https://*.googleapis.com https://www.gstatic.com https://*.gstatic.com https://accounts.google.com; style-src 'self' 'unsafe-inline'; connect-src 'self' https://apis.google.com https://*.googleapis.com https://accounts.google.com https://www.googleapis.com; frame-src https://accounts.google.com https://content.googleapis.com; img-src 'self' data: https: http://csi.gstatic.com http://*.gstatic.com;">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="icon" href="./assets/app-icon.png" type="image/png">
    <link rel="apple-touch-icon" href="./assets/app-icon.png">
    <title>Church Financial Management System</title>
    <style>
        :root {
            --primary: #0f4c3a;
            --primary-dark: #0b3a2c;
            --primary-light: #d7ebe2;
            --accent: #c6a34b;
            --accent-soft: #efe3c6;
            --surface: #ffffff;
            --background: #f7f4ef;
            --background-alt: #efe9e0;
            --border: #e3ddd2;
            --text: #1b1f1b;
            --text-secondary: #5b6b60;
            --text-light: #8b9a90;
            --success: #2f8f6a;
            --warning: #c79a3a;
            --danger: #d64545;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --radius: 8px;
            --radius-lg: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Avenir Next", Avenir, Optima, "Palatino Linotype", Palatino, Georgia, serif;
            background: radial-gradient(circle at top right, #fdfbf7 0%, var(--background) 55%, #f2ede4 100%);
            color: var(--text);
            line-height: 1.6;
            padding: 24px;
            min-height: 100vh;
        }

        .container {
            max-width: 1440px;
            margin: 0 auto;
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }

        header {
            background: linear-gradient(180deg, #ffffff 0%, #f8f5f0 100%);
            border-bottom: 1px solid var(--border);
            padding: 28px 32px;
        }

        header h1 {
            font-family: Optima, "Palatino Linotype", Palatino, Georgia, serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 16px;
            letter-spacing: 0.02em;
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .header-controls input[type="month"] {
            padding: 10px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            background: var(--surface);
            color: var(--text);
            transition: all 0.2s;
            font-weight: 500;
        }

        .header-controls input[type="month"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .header-controls button {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .header-controls button:hover {
            background: var(--background);
            border-color: var(--text-secondary);
        }

        .header-controls button.btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .header-controls button.btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .tabs {
            display: flex;
            background: var(--background-alt);
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
            padding: 0 24px;
        }

        .tab {
            padding: 16px 24px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab:hover {
            color: var(--text);
            background: rgba(15, 76, 58, 0.06);
        }

        .tab.active {
            color: var(--primary);
            background: transparent;
            border-bottom-color: var(--accent);
        }

        .tab-content {
            display: none;
            padding: 32px;
            animation: fadeIn 0.2s ease-out;
            max-width: 1200px;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
            font-size: 0.875rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            background: var(--surface);
            color: var(--text);
            transition: all 0.2s;
            font-family: inherit;
        }

        .form-group input:hover,
        .form-group select:hover,
        .form-group textarea:hover {
            border-color: var(--text-secondary);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .form-group input[type="date"]::-webkit-calendar-picker-indicator,
        .form-group input[type="month"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .form-group input[type="date"]::-webkit-calendar-picker-indicator:hover,
        .form-group input[type="month"]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-section {
            background: var(--background-alt);
            padding: 24px;
            border-radius: var(--radius);
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }

        .form-section h3 {
            margin-bottom: 20px;
            color: var(--text);
            font-size: 1rem;
            font-weight: 700;
        }

        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: var(--radius);
            font-size: 0.875rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            box-shadow: var(--shadow);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            box-shadow: var(--shadow);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            padding: 6px 12px;
            font-size: 0.8125rem;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
            padding: 6px 12px;
            font-size: 0.8125rem;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-secondary {
            background: var(--text-secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--text);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: var(--surface);
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid var(--border);
            font-size: 0.875rem;
        }

        th {
            background: var(--background-alt);
            color: var(--text);
            padding: 12px 16px;
            text-align: left;
            font-weight: 700;
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: var(--background-alt);
        }

        .summary-card {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 24px;
            border-radius: var(--radius);
            margin-bottom: 24px;
            text-align: center;
        }

        .summary-card h2 {
            font-size: 2rem;
            margin-top: 8px;
            color: var(--text);
            font-weight: 700;
        }

        .department-grid {
            display: grid;
            gap: 16px;
        }

        .balance-positive {
            color: var(--success);
            font-weight: 700;
        }

        .balance-negative {
            color: var(--danger);
            font-weight: 700;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            animation: fadeIn 0.2s;
        }

        .modal-content {
            background: var(--surface);
            margin: 5% auto;
            padding: 32px;
            border-radius: var(--radius-lg);
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text);
        }

        .close {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            line-height: 1;
            transition: color 0.2s;
        }

        .close:hover {
            color: var(--text);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 24px;
            border-radius: var(--radius);
            transition: all 0.2s;
        }

        .stat-card:hover {
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .stat-card h4 {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-card .amount {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text);
        }

        .report-section {
            margin-bottom: 32px;
            padding: 24px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .report-brand {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .report-logo {
            width: 110px;
            height: 110px;
            object-fit: contain;
            background: #ffffff;
            border-radius: 8px;
            padding: 6px;
        }

        .report-title-group h2 {
            margin: 0;
            font-family: Optima, "Palatino Linotype", Palatino, Georgia, serif;
            font-size: 1.6rem;
            letter-spacing: 0.02em;
        }

        .report-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .report-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .report-stat {
            border-left: 4px solid var(--primary);
        }

        .report-stat.church {
            border-left-color: var(--accent);
        }

        .report-stat.total {
            border-left-color: var(--text);
        }

        .report-section h2 {
            color: var(--text);
            margin-bottom: 20px;
            font-size: 1.25rem;
            font-weight: 700;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }

        .filter-bar {
            background: var(--background-alt);
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 24px;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: end;
            border: 1px solid var(--border);
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .empty-state {
            text-align: center;
            padding: 64px 32px;
            color: var(--text-light);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Login Screen Styles */
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f4c3a 0%, #163d35 70%, #2f8f6a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        #loginScreen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(198, 163, 75, 0.12) 0%, transparent 55%);
            z-index: -1;
        }

        .login-container {
            background: var(--surface);
            padding: 48px;
            border-radius: var(--radius-lg);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 480px;
            position: relative;
            z-index: 1;
        }

        .login-container h2 {
            color: var(--text);
            margin-bottom: 32px;
            font-size: 1.875rem;
            font-weight: 700;
            text-align: center;
        }

        .login-form .form-group {
            margin-bottom: 24px;
        }

        .login-form input::placeholder {
            color: var(--text-light);
        }

        #loginFormContainer,
        #signupFormContainer {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 12px 16px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            font-size: 0.875rem;
            display: none;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-error.show {
            display: block;
        }

        /* User Display */
        #currentUserDisplay {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--background-alt);
            border-radius: var(--radius);
            font-size: 0.875rem;
            color: var(--text);
            border: 1px solid var(--border);
        }

        #logoutBtn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        #logoutBtn:hover {
            background: #dc2626;
        }

        #changePasswordBtn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 0.875rem;
            font-weight: 600;
            border-radius: 4px;
            cursor: pointer;
        }

        #changePasswordBtn:hover {
            background: var(--warning);
            opacity: 0.9;
        }

        /* User Role Badge */
        .role-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .role-badge.admin {
            background: #dbeafe;
            color: #1e40af;
        }

        .role-badge.user {
            background: #e5e7eb;
            color: #374151;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
        }

        /* Currency Formatting */
        .currency {
            text-align: right;
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Courier New', monospace;
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* Receipt Number */
        .receipt-num {
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Courier New', monospace;
            font-weight: 600;
            color: var(--primary);
        }

        /* Sortable Headers */
        .sortable {
            cursor: pointer;
            user-select: none;
        }

        .sortable:hover {
            background: var(--background);
        }

        /* Card Hover Effects */
        .card {
            transition: all 0.2s;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        /* Archive Cards */
        .archive-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .archive-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .archive-item h4 {
            color: var(--text);
            margin-bottom: 8px;
            font-weight: 700;
        }

        .archive-item p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Department Cards */
        .department-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
        }

        .department-card h4 {
            color: var(--text);
            margin-bottom: 12px;
            font-weight: 700;
            font-size: 1rem;
        }

        .department-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.875rem;
        }

        .department-row span:first-child {
            color: var(--text-secondary);
        }

        .department-row span:last-child {
            font-weight: 600;
            color: var(--text);
        }

        /* Cloud Sync Status */
        #cloudSyncStatus {
            padding: 8px 16px;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        #googleDriveInitStatus {
            padding: 6px 12px;
            border-radius: var(--radius);
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            max-width: 380px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .init-status-muted {
            background: #e5e7eb;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .init-status-ok {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .init-status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .shared-file-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        #sharedFileIdInput {
            min-width: 240px;
        }

        #sharedFileStatus {
            padding: 6px 12px;
            border-radius: var(--radius);
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
        }

        .status-enabled {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .status-disabled {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            header {
                padding: 20px 16px;
            }

            header h1 {
                font-size: 1.5rem;
            }

            .tab-content {
                padding: 20px 16px;
            }

            .tabs {
                padding: 0 12px;
            }

            .tab {
                padding: 12px 16px;
                font-size: 0.8125rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .login-container {
                padding: 32px 24px;
                margin: 16px;
            }
        }

        @media print {
            @page {
                margin: 10mm 12mm;
                size: A4;
            }

            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            body {
                background: white;
                padding: 0;
                margin: 0;
                font-size: 9pt;
                line-height: 1.3;
            }
            
            .container {
                box-shadow: none;
                margin: 0;
                width: 100%;
                border-radius: 0;
                padding: 0;
            }
            
            .tabs, .btn, .filter-bar, header .header-controls {
                display: none !important;
            }
            
            .tab-content {
                display: none !important;
            }

            #monthlyReportTab {
                display: block !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            .report-actions {
                display: none !important;
            }

            .report-header {
                justify-content: flex-start;
                border-bottom: 1px solid #cfc7b8;
            }

            .report-logo {
                width: 120px;
                height: 120px;
                padding: 6px;
            }

            header {
                background: white;
                color: #333;
                padding: 5px 0;
                margin-bottom: 8px;
                border-bottom: 2px solid #333;
                text-align: center;
                page-break-after: avoid;
            }

            header h1 {
                font-size: 16pt;
                margin: 3px 0;
                font-weight: bold;
            }

            #cloudSyncStatus {
                display: none !important;
            }

            #reportContent {
                margin: 0 !important;
                padding: 0 !important;
            }

            #monthlyReportTab .form-group {
                display: block !important;
                max-width: 100% !important;
                margin: 0 0 8px 0 !important;
                page-break-after: avoid;
            }

            #monthlyReportTab .form-group label {
                display: none !important;
            }

            #churchName {
                display: block !important;
                border: none !important;
                background: transparent !important;
                text-align: center;
                font-size: 14pt;
                font-weight: bold;
                padding: 3px 0;
                margin: 0 0 5px 0;
            }

            h2 {
                font-size: 12pt;
                margin: 8px 0 6px 0;
                border-bottom: 1.5px solid #666;
                padding-bottom: 3px;
                font-weight: bold;
                page-break-after: avoid;
            }

            .report-section:first-child h2 {
                margin-top: 0 !important;
            }

            h3 {
                font-size: 10pt;
                margin: 8px 0 5px 0;
                page-break-after: avoid;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                margin: 5px 0 10px 0;
                font-size: 8pt;
                page-break-inside: auto;
            }

            table thead {
                display: table-header-group;
            }

            table tbody tr {
                page-break-inside: avoid;
            }

            table th {
                background: #e0e0e0 !important;
                border: 1px solid #888;
                padding: 4px 3px;
                font-weight: bold;
                text-align: left;
                font-size: 8pt;
            }

            table td {
                border: 1px solid #bbb;
                padding: 3px 3px;
            }

            .currency {
                text-align: right !important;
            }

            .stats-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
                margin: 8px 0;
                page-break-inside: avoid;
            }

            .stat-card {
                background: #f0f0f0 !important;
                border: 1px solid #555 !important;
                padding: 6px;
                border-radius: 0 !important;
            }

            .stat-card h4 {
                font-size: 9pt;
                color: #222 !important;
                margin: 0 0 3px 0 !important;
                font-weight: bold;
            }

            .stat-card .amount {
                font-size: 13pt;
                color: #000 !important;
                font-weight: bold;
                margin: 2px 0;
                line-height: 1.1;
            }

            .stat-card small {
                font-size: 7pt;
                color: #555 !important;
                display: block;
                margin-top: 2px;
            }

            .report-section {
                margin-bottom: 12px;
                page-break-inside: auto;
            }

            .empty-state {
                text-align: center;
                font-style: italic;
                color: #666;
            }

            .form-group:not(#monthlyReportTab .form-group) {
                display: none !important;
            }
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .currency {
            text-align: right;
            font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
        }

        .receipt-num {
            font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
            font-weight: 600;
            color: var(--primary);
        }

        .sortable {
            cursor: pointer;
        }
    </style>
    
    <!-- Google Drive API Configuration -->
    <script src="https://apis.google.com/js/api.js"></script>
    
    <script>
        // Google Drive API Setup
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const CLIENT_ID = '315446735259-eqs8103bdbfre1v3l8k028dbismju8tl.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyA2vkE8JKUxUQfF9pO2m7XbpIx_AWBHfmA';
        const FILE_NAME = 'Church Finance System.json';
        
        let googleDriveFileId = null;
        let sharedDriveFileId = null;
        let sharedFileCanEdit = null;
        let sharedSyncReadOnlyWarnShown = false;
        let googleDriveInitialized = false;
        let cloudSyncEnabled = false;
        let currentUser = null;
        let cloudRole = 'shared';
        let gapiScriptLoading = null;
        let gsiScriptLoading = null;
        let tokenClient = null;
        let accessToken = null;
        let tokenExpiresAt = 0;

        function loadGoogleApiScript() {
            if (typeof gapi !== 'undefined') {
                return Promise.resolve();
            }
            if (gapiScriptLoading) {
                return gapiScriptLoading;
            }
            gapiScriptLoading = new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://apis.google.com/js/api.js';
                script.async = true;
                script.onload = () => resolve();
                script.onerror = () => reject(new Error('Failed to load Google API script'));
                document.head.appendChild(script);
            }).finally(() => {
                gapiScriptLoading = null;
            });
            return gapiScriptLoading;
        }

        function loadGoogleIdentityScript() {
            if (window.google && google.accounts && google.accounts.oauth2) {
                return Promise.resolve();
            }
            if (gsiScriptLoading) {
                return gsiScriptLoading;
            }
            gsiScriptLoading = new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://accounts.google.com/gsi/client';
                script.async = true;
                script.defer = true;
                script.onload = () => resolve();
                script.onerror = () => reject(new Error('Failed to load Google Identity script'));
                document.head.appendChild(script);
            }).finally(() => {
                gsiScriptLoading = null;
            });
            return gsiScriptLoading;
        }

        function getCloudRole() {
            return currentLoggedInUser && currentLoggedInUser.role === 'admin' ? 'admin' : 'shared';
        }

        function getCloudLabel(role) {
            return role === 'admin' ? 'Admin Google Account' : 'Shared Google Account';
        }

        function isFileProtocol() {
            return window.location.protocol === 'file:';
        }

        function getGoogleErrorMessage(error) {
            if (!error) {
                return 'Unknown error';
            }
            if (typeof error === 'string') {
                return error;
            }
            if (error.error) {
                return typeof error.error === 'string' ? error.error : JSON.stringify(error.error);
            }
            if (error.details) {
                return typeof error.details === 'string' ? error.details : JSON.stringify(error.details);
            }
            if (error.message) {
                return error.message;
            }
            try {
                return JSON.stringify(error);
            } catch (err) {
                return 'Unserializable error';
            }
        }

        function setGoogleDriveInitStatus(type, message) {
            const statusEl = document.getElementById('googleDriveInitStatus');
            if (!statusEl) {
                return;
            }
            const classes = ['init-status-muted', 'init-status-ok', 'init-status-error'];
            statusEl.classList.remove(...classes);
            statusEl.classList.add(type);
            statusEl.textContent = message;
            statusEl.title = message;
        }

        function isTokenValid() {
            return Boolean(accessToken) && Date.now() < tokenExpiresAt - 60000;
        }

        function initTokenClient() {
            if (tokenClient) {
                return;
            }
            if (!window.google || !google.accounts || !google.accounts.oauth2) {
                throw new Error('Google Identity Services not available');
            }
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: () => {}
            });
        }

        function requestAccessToken(interactive) {
            return new Promise((resolve, reject) => {
                if (!tokenClient) {
                    reject(new Error('Token client not initialized'));
                    return;
                }
                tokenClient.callback = (tokenResponse) => {
                    if (tokenResponse && tokenResponse.access_token) {
                        accessToken = tokenResponse.access_token;
                        tokenExpiresAt = Date.now() + (tokenResponse.expires_in || 0) * 1000;
                        gapi.client.setToken({ access_token: accessToken });
                        // Save token and expiry to localStorage
                        localStorage.setItem('googleAccessToken', accessToken);
                        localStorage.setItem('googleTokenExpiresAt', tokenExpiresAt.toString());
                        resolve(true);
                        return;
                    }
                    const errorMessage = tokenResponse && tokenResponse.error
                        ? tokenResponse.error
                        : 'No access token received';
                    reject(new Error(errorMessage));
                };
                tokenClient.requestAccessToken({ prompt: interactive ? 'consent' : '' });
            });
        }

        async function ensureAccessToken(role) {
            try {
                if (isTokenValid()) {
                    cloudSyncEnabled = true;
                    currentUser = { name: getCloudLabel(role) };
                    updateCloudSyncUI();
                    return true;
                }
                initTokenClient();
                await requestAccessToken(true);
                cloudSyncEnabled = true;
                currentUser = { name: getCloudLabel(role) };
                updateCloudSyncUI();
                return true;
            } catch (error) {
                console.error('Google sign-in error:', error);
                setGoogleDriveInitStatus('init-status-error', `Google sign-in error: ${getGoogleErrorMessage(error)}`);
                cloudSyncEnabled = false;
                currentUser = null;
                updateCloudSyncUI();
                return false;
            }
        }
        
        // Initialize Google Drive API (client OAuth)
        async function initGoogleDrive() {
            return new Promise((resolve) => {
                if (isFileProtocol()) {
                    googleDriveInitialized = false;
                    setGoogleDriveInitStatus('init-status-error', 'Google API: unavailable on file://. Use http://localhost:8000');
                    updateCloudSyncUI();
                    resolve();
                    return;
                }
                setGoogleDriveInitStatus('init-status-muted', 'Google API: initializing...');
                Promise.all([loadGoogleApiScript(), loadGoogleIdentityScript()])
                    .then(() => {
                        if (typeof gapi === 'undefined') {
                            console.error('Google API script not available after load.');
                            googleDriveInitialized = false;
                            setGoogleDriveInitStatus('init-status-error', 'Google API: script not available');
                            resolve();
                            return;
                        }
                        if (!window.google || !google.accounts || !google.accounts.oauth2) {
                            console.error('Google Identity Services not available after load.');
                            googleDriveInitialized = false;
                            setGoogleDriveInitStatus('init-status-error', 'Google Identity: script not available');
                            resolve();
                            return;
                        }
                        gapi.load('client', async () => {
                            try {
                                await gapi.client.init({
                                    discoveryDocs: DISCOVERY_DOCS
                                });
                                initTokenClient();
                                googleDriveInitialized = true;
                                console.log('Google Drive API initialized');
                                setGoogleDriveInitStatus('init-status-ok', 'Google API: ready');
                                updateCloudSyncUI();
                                resolve();
                            } catch (error) {
                                console.error('Google Drive init error:', error);
                                console.error('Error details:', JSON.stringify(error, null, 2));
                                googleDriveInitialized = false;
                                setGoogleDriveInitStatus('init-status-error', `Google API init error: ${getGoogleErrorMessage(error)}`);
                                resolve();
                            }
                        });
                    })
                    .catch((error) => {
                        console.error('Google API script load error:', error);
                        googleDriveInitialized = false;
                        setGoogleDriveInitStatus('init-status-error', `Google API script error: ${getGoogleErrorMessage(error)}`);
                        resolve();
                    });
            });
        }

        async function ensureGoogleDriveReady() {
            if (googleDriveInitialized) {
                return true;
            }
            await initGoogleDrive();
            return googleDriveInitialized;
        }
    </script>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-container">
            <h2>Church Financial System</h2>
            
            <div id="loginFormContainer">
                <div id="authError" class="login-error"></div>
                <form id="loginForm" class="login-form" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="loginUsername" required />
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" required />
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                </form>
                <div style="text-align: center; margin-top: 24px; color: var(--text-secondary); font-size: 0.875rem;">
                    Access is restricted to authorized data-entry staff.
                    <br><a href="#" onclick="toggleAuthForm(); return false;" style="color: var(--primary); font-weight: 600; text-decoration: none;">Create an account</a>
                </div>
            </div>
            
            <div id="signupFormContainer" style="display: none;">
                <div id="signupError" class="login-error"></div>
                <form id="signupForm" class="login-form" onsubmit="handleSignup(event)">
                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text" id="signupFirstName" required placeholder="Your first name" />
                    </div>
                    <div class="form-group">
                        <label>Surname</label>
                        <input type="text" id="signupSurname" required placeholder="Your surname" />
                    </div>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="signupUsername" required placeholder="Choose a username" />
                    </div>
                    <div class="form-group">
                        <label>Gmail Address</label>
                        <input type="email" id="signupEmail" required placeholder="name@gmail.com" />
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="signupPassword" required minlength="6" placeholder="At least 6 characters" />
                    </div>
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <input type="password" id="signupConfirmPassword" required placeholder="Re-enter password" />
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Create Account</button>
                </form>
                <div style="text-align: center; margin-top: 24px; color: var(--text-secondary); font-size: 0.875rem;">
                    Already have an account? <a href="#" onclick="toggleAuthForm(); return false;" style="color: var(--primary); font-weight: 600; text-decoration: none;">Login</a>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="mainApp" style="display: none;">
        <header>
            <h1>Church Financial Management System</h1>
            <div class="header-controls">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div id="currentUserDisplay"></div>
                    <button id="changePasswordBtn" onclick="openChangeMyPasswordModal()" title="Change your password">üîê Change Password</button>
                    <button id="logoutBtn" onclick="logout()">Logout</button>
                </div>
                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                    <input type="month" id="monthSelector" />
                    <button onclick="newMonth()">New Month</button>
                    <button onclick="saveData()">Save Data</button>
                    <button onclick="toggleCloudSync()" id="cloudSyncBtn" class="btn-success">Cloud Sync</button>
                    <button onclick="disconnectCloudSync()" id="cloudDisconnectBtn" class="btn-warning" style="display: none;">Disconnect</button>
                    <button onclick="downloadBackup()" class="btn btn-secondary">üì• Download Backup</button>
                    <button onclick="uploadBackup()" class="btn btn-secondary">üì§ Restore Backup</button>
                    <div id="cloudSyncStatus"></div>
                    <div id="googleDriveInitStatus" class="init-status-muted">Google API: idle</div>
                    <div class="shared-file-controls">
                        <input type="text" id="sharedFileIdInput" placeholder="Shared Drive File ID" />
                        <button onclick="setSharedDriveFileId()" class="btn btn-secondary">Set Shared ID</button>
                        <button onclick="clearSharedDriveFileId()" class="btn btn-warning">Clear ID</button>
                        <div id="sharedFileStatus" class="status-disabled">No shared file ID</div>
                    </div>
                </div>
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">Data Entry</button>
            <button class="tab" onclick="switchTab(1)">Department Accounting</button>
            <button class="tab" onclick="switchTab(2)">Expense Tracking</button>
            <button class="tab" onclick="switchTab(3)">YAC Designated Funds</button>
            <button class="tab" onclick="switchTab(4)">Monthly Report</button>
            <button class="tab" onclick="switchTab(5)">Members</button>
            <button class="tab" onclick="switchTab(6)">Archives</button>
            <button class="tab" onclick="switchTab(7)" id="userAccountsTab" style="display: none;">User Accounts</button>
        </div>

        <!-- TAB 1: DATA ENTRY -->
        <div class="tab-content active">
            <h2>Weekly Collections Entry</h2>
            
            <form id="entryForm" onsubmit="addWeeklyEntry(event)" novalidate>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" id="entryDate" required />
                    </div>
                    <div class="form-group">
                        <label>Receipt Number</label>
                        <input type="text" id="receiptNumber" />
                    </div>
                    <div class="form-group">
                        <label>Member Name *</label>
                        <input type="text" id="memberName" list="memberList" required />
                        <datalist id="memberList"></datalist>
                    </div>
                    <div class="form-group">
                        <label>Tithes (100% to Mission)</label>
                        <input type="number" id="tithes" step="0.01" min="0" />
                    </div>
                </div>

                <div class="form-section">
                    <h3>Shared Offerings (55% Mission / 45% Departments)</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>One Fund Offering</label>
                            <input type="number" step="0.01" min="0" id="oneFund" />
                        </div>
                        <div class="form-group">
                            <label>Special Offering</label>
                            <input type="number" step="0.01" min="0" id="specialOffering" />
                        </div>
                        <div class="form-group">
                            <label>Church Offering</label>
                            <input type="number" step="0.01" min="0" id="churchOffering" />
                        </div>
                        <div class="form-group">
                            <label>Sabbath School Offering</label>
                            <input type="number" step="0.01" min="0" id="sabbathSchoolOffering" />
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Designated Offerings (100% to YAC)</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Children's SS Project</label>
                            <input type="number" step="0.01" min="0" id="childrenSS" />
                        </div>
                        <div class="form-group">
                            <label>AY Project Offering</label>
                            <input type="number" step="0.01" min="0" id="ayProject" />
                        </div>
                        <div class="form-group">
                            <label>Church Expense</label>
                            <input type="number" step="0.01" min="0" id="churchExpense" />
                        </div>
                        <div class="form-group">
                            <label>Potluck Donation</label>
                            <input type="number" step="0.01" min="0" id="potluck" />
                        </div>
                        <div class="form-group">
                            <label>Other Donation</label>
                            <input type="number" step="0.01" min="0" id="otherDonation" />
                        </div>
                        <div class="form-group">
                            <label>Children's Division Outreach Donation</label>
                            <input type="number" step="0.01" min="0" id="childrenOutreach" />
                        </div>
                        <div class="form-group">
                            <label>AY Outreach Donation</label>
                            <input type="number" step="0.01" min="0" id="ayOutreach" />
                        </div>
                        <div class="form-group">
                            <label>Church Fund</label>
                            <input type="number" step="0.01" min="0" id="churchFund" />
                        </div>
                        <div class="form-group">
                            <label>Church Community Donation</label>
                            <input type="number" step="0.01" min="0" id="churchCommunity" />
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; align-items: center;">
                    <button type="submit" class="btn btn-primary" id="entrySubmitButton">‚ûï Add Entry</button>
                    <button type="button" class="btn btn-secondary" id="entryCancelButton" onclick="cancelEditEntry()" style="display: none;">
                        Cancel Edit
                    </button>
                </div>
            </form>

            <div style="margin-top: 40px;">
                <h3>Current Month Entries</h3>
                <table id="entriesTable">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="setEntrySort('date')">Date</th>
                            <th class="sortable" onclick="setEntrySort('receipt')">Receipt #</th>
                            <th class="sortable" onclick="setEntrySort('member')">Member Name</th>
                            <th class="currency sortable" onclick="setEntrySort('tithes')">Tithes</th>
                            <th class="currency sortable" onclick="setEntrySort('shared')">Shared Total</th>
                            <th class="currency sortable" onclick="setEntrySort('designated')">Designated Total</th>
                            <th class="currency sortable" onclick="setEntrySort('total')">Entry Total</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="entriesBody"></tbody>
                </table>
            </div>
        </div>

        <!-- TAB 2: DEPARTMENT ACCOUNTING -->
        <div class="tab-content">
            <h2>Department Accounting</h2>
            
            <div class="summary-card">
                <div>Total Department Pool (45% Shared + Church Fund)</div>
                <h2 id="departmentPoolTotal">$0.00</h2>
            </div>

            <table id="departmentTable">
                <thead>
                    <tr>
                        <th>Department</th>
                        <th>Allocation %</th>
                        <th class="currency">Allocated (Income)</th>
                        <th class="currency">Spent (Expenses)</th>
                        <th class="currency">Balance</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="departmentBody"></tbody>
            </table>

            <div style="margin-top: 40px;">
                <h3>Monthly TAM & YAC Record</h3>
                <table id="monthlyTAMYACTable" style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                    <thead>
                        <tr style="background: #f3f4f6;">
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #d1d5db;">Month</th>
                            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #d1d5db;">TAM Share (55% Mission)</th>
                            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #d1d5db;">YAC Share (45% Local)</th>
                            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #d1d5db;">Designated</th>
                        </tr>
                    </thead>
                    <tbody id="monthlyTAMYACBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- TAB 3: EXPENSE TRACKING -->
        <div class="tab-content">
            <h2>Expense Tracking</h2>

            <form id="expenseForm" onsubmit="addExpense(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" id="expenseDate" required />
                    </div>
                    <div class="form-group">
                        <label>Department *</label>
                        <select id="expenseDepartment" required></select>
                    </div>
                    <div class="form-group">
                        <label>Description *</label>
                        <input type="text" id="expenseDescription" required />
                    </div>
                    <div class="form-group">
                        <label>Amount *</label>
                        <input type="number" id="expenseAmount" step="0.01" min="0.01" required />
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="expenseType">
                            <option>Expense</option>
                            <option>Transfer</option>
                            <option>Adjustment</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Check/Reference #</label>
                        <input type="text" id="expenseReference" />
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">üí∏ Record Expense</button>
            </form>

            <div class="filter-bar" style="margin-top: 30px;">
                <div class="filter-group">
                    <label>Filter by Department</label>
                    <select id="expenseFilterDept" onchange="renderExpenses()">
                        <option value="">All Departments</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>From Date</label>
                    <input type="date" id="expenseFilterFrom" onchange="renderExpenses()" />
                </div>
                <div class="filter-group">
                    <label>To Date</label>
                    <input type="date" id="expenseFilterTo" onchange="renderExpenses()" />
                </div>
            </div>

            <table id="expenseTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Department</th>
                        <th>Description</th>
                        <th class="currency">Amount</th>
                        <th>Type</th>
                        <th>Ref #</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="expenseBody"></tbody>
            </table>
        </div>

        <!-- TAB 4: Church Project/Donations -->
        <div class="tab-content">
            <h2>Church Project/Donations (100% Tracking)</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h4>Total Designated Income</h4>
                    <div class="amount" id="totalDesignatedIncome">$0.00</div>
                </div>
                <div class="stat-card">
                    <h4>Total Designated Expenses</h4>
                    <div class="amount" id="totalDesignatedExpenses">$0.00</div>
                </div>
                <div class="stat-card">
                    <h4>Total Designated Balance</h4>
                    <div class="amount" id="totalDesignatedBalance">$0.00</div>
                </div>
            </div>

            <table id="yacTable">
                <thead>
                    <tr>
                        <th>Projects/Donations</th>
                        <th class="currency">Income (Collected)</th>
                        <th class="currency">Expenses (Spent)</th>
                        <th class="currency">Balance</th>
                    </tr>
                </thead>
                <tbody id="yacBody"></tbody>
            </table>
        </div>

        <!-- TAB 5: MONTHLY REPORT -->
        <div class="tab-content" id="monthlyReportTab">
            <div class="report-header">
                <div class="report-brand">
                    <img src="./assets/report-logo.png" alt="Yanhee Adventist Church" class="report-logo" />
                    <div class="report-title-group">
                        <h2>Monthly Financial Report</h2>
                        <div class="report-subtitle">Yanhee Adventist Church</div>
                    </div>
                </div>
                <div class="report-actions">
                    <button class="btn btn-success" onclick="exportToPDF()">Export to PDF</button>
                    <button class="btn btn-secondary" onclick="exportToCSV()">Export to CSV</button>
                    <button class="btn btn-primary" onclick="window.print()">Print</button>
                </div>
            </div>

            <div class="form-group" style="max-width: 400px;">
                <label>Church Name</label>
                <input type="text" id="churchName" placeholder="Enter church name" onchange="saveChurchName()" />
            </div>

            <div id="reportContent">
                <div class="report-section">
                    <h2>WEEKLY COLLECTIONS BY MEMBER</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Name</th>
                                <th>Receipt #</th>
                                <th class="currency">Total Received</th>
                                <th class="currency">Total Mission Fund</th>
                                <th class="currency">Tithe</th>
                                <th class="currency">TAM Share</th>
                                <th class="currency">Total Church Fund</th>
                                <th class="currency">YAC Share</th>
                                <th class="currency">Total Donations</th>
                            </tr>
                        </thead>
                        <tbody id="memberCollectionsBody"></tbody>
                    </table>
                </div>

                <div class="stats-grid" style="margin-top: 30px;">
                    <div class="stat-card report-stat mission">
                        <h4>TOTAL MISSION FUNDS</h4>
                        <div class="amount" id="tamShareAmount">$0.00</div>
                        <small style="opacity: 0.9; display: block; margin-top: 10px;">Tithes + TAM Share (55% of Shared)</small>
                    </div>
                    <div class="stat-card report-stat church">
                        <h4>TOTAL CHURCH FUNDS</h4>
                        <div class="amount" id="yacShareAmount">$0.00</div>
                        <small style="opacity: 0.9; display: block; margin-top: 10px;">YAC Share (45%) + Designated Offerings</small>
                    </div>
                    <div class="stat-card report-stat total">
                        <h4>TOTAL RECEIVED</h4>
                        <div class="amount" id="totalCollectionsAmount">$0.00</div>
                        <small style="opacity: 0.9; display: block; margin-top: 10px;">Mission Funds + Church Funds</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 6: MEMBERS MANAGEMENT -->
        <div class="tab-content">
            <h2>Members Management</h2>
            
            <div class="form-section">
                <h3>Add New Member</h3>
                <form id="memberForm" onsubmit="addMember(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Member Name *</label>
                            <input type="text" id="newMemberName" required placeholder="Enter member name" />
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">‚ûï Add Member</button>
                </form>
            </div>

            <div style="margin-top: 30px;">
                <h3 id="memberCountHeading">Member List (0 members)</h3>
                <div id="membersList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px; margin-top: 20px;">
                </div>
            </div>
        </div>

        <!-- TAB 7: ARCHIVES -->
        <div class="tab-content">
            <h2>Monthly Archives</h2>
            
            <div id="archivesList" style="margin-top: 20px;">
            </div>

            <!-- Archive Detail Modal -->
            <div id="archiveDetailModal" class="modal">
                <div class="modal-content" style="width: 90%; max-width: 1000px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h2 id="archiveDetailTitle">Archive Details</h2>
                        <span class="close" onclick="closeArchiveDetail()">&times;</span>
                    </div>
                    <div id="archiveDetailContent" style="padding: 20px;">
                    </div>
                    <div style="padding: 20px; border-top: 1px solid #ddd; text-align: right; display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn btn-warning" onclick="editArchivedMonth(window.currentArchiveIndex)">‚úèÔ∏è Edit This Month</button>
                        <button class="btn btn-primary" onclick="exportArchiveCSV()">üì• Export as CSV</button>
                        <button class="btn" onclick="closeArchiveDetail()">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 8: USER ACCOUNTS -->
        <div class="tab-content">
            <h2>User Accounts & Audit Log</h2>
            
            <div style="margin-top: 20px;">
                <h3>Active Users</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Role</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersBody"></tbody>
                </table>
            </div>

            <div style="margin-top: 40px;">
                <h3>Audit Log (Recent 100 Activities)</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Date/Time</th>
                            <th>User</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="auditLogBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Change Your Password</h2>
                <span class="close" onclick="closeChangePasswordModal()">&times;</span>
            </div>
            <div style="background: #dbeafe; border: 1px solid #93c5fd; color: #1e40af; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 0.875rem;">
                üí° <strong>Tip:</strong> Type the password in the FIRST field, then type it again in the SECOND field.
            </div>
            <div id="changePasswordError" class="login-error"></div>
            <form id="changePasswordForm" onsubmit="handleChangePassword(event)" autocomplete="off">
                <input type="hidden" id="changePasswordUsername" />
                <div class="form-group">
                    <label><strong>1Ô∏è‚É£ New Password</strong> (Type here first)</label>
                    <input type="password" id="confirmNewPassword" required minlength="6" placeholder="Type your new password here" autocomplete="off" style="font-size: 1rem;" name="pwd1" />
                </div>
                <div class="form-group">
                    <label><strong>2Ô∏è‚É£ Confirm New Password</strong> (Type the same password again)</label>
                    <input type="password" id="newPassword" required placeholder="Re-type the same password" autocomplete="off" style="font-size: 1rem;" name="pwd2" />
                </div>
                <div class="form-group" style="margin-bottom: 8px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="showPasswordToggle" onclick="togglePasswordVisibility()" />
                        <span style="font-size: 0.875rem;">Show passwords (recommended to verify)</span>
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">Update Password</button>
            </form>
        </div>
    </div>

    <!-- Modal for Add Expense -->

    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Department Expense</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="modalExpenseForm" onsubmit="addModalExpense(event)">
                <input type="hidden" id="modalDepartment" />
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="modalExpenseDate" required />
                </div>
                <div class="form-group">
                    <label>Description *</label>
                    <input type="text" id="modalExpenseDescription" required />
                </div>
                <div class="form-group">
                    <label>Amount *</label>
                    <input type="number" id="modalExpenseAmount" step="0.01" min="0.01" required />
                </div>
                <div class="form-group">
                    <label>Check/Reference #</label>
                    <input type="text" id="modalExpenseReference" />
                </div>
                <button type="submit" class="btn btn-primary">Add Expense</button>
            </form>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch((error) => {
                    console.error('Service worker registration failed:', error);
                });
            });
        }

        // Department structure with exact percentages
        const departments = [
            { name: "CHURCH EXPENSES", percentage: 0.50 },
            { name: "SABBATH SCHOOL", percentage: 0.09 },
            { name: "PERSONAL MINISTRY", percentage: 0.06 },
            { name: "AY COUNCIL", percentage: 0.06 },
            { name: "CHILDREN'S & FAMILY MINISTRY", percentage: 0.04 },
            { name: "EMERGENCY FUND", percentage: 0.08 },
            { name: "MEDIA MINISTRY", percentage: 0.05 },
            { name: "MUSIC MINISTRY", percentage: 0.05 },
            { name: "HEALTH MINISTRY", percentage: 0.02 },
            { name: "DORCAS MINISTRY", percentage: 0.01 },
            { name: "WOMEN'S MINISTRY", percentage: 0.01 },
            { name: "COMMUNITY MINISTRY", percentage: 0.01 },
            { name: "ELDER'S MINISTRY", percentage: 0.02 }
        ];

        const designatedCategories = [
            "Children's SS Project",
            "AY Project Offering",
            "Church Expense (Designated)",
            "Potluck Donation",
            "Other Donation",
            "Children's Division Outreach Donation",
            "AY Outreach Donation",
            "Church Fund",
            "Church Community Donation"
        ];

        const CHURCH_DATA_DEFAULTS = {
            currentMonth: "",
            churchName: "",
            beginningBalance: 0,
            weeklyEntries: [],
            expenses: [],
            monthlyArchives: [],
            members: [],
            cumulativeDepartmentBalances: {}, // Track cumulative balances across all months
            monthlyTAMYAC: [], // Track TAM and YAC values for each month
            auditLog: [] // Track all changes with user and timestamp
        };

        // Main data store
        let churchData = { ...CHURCH_DATA_DEFAULTS };

        function normalizeChurchData(rawData) {
            let parsedData = rawData;

            if (typeof parsedData === 'string') {
                try {
                    parsedData = JSON.parse(parsedData);
                } catch (error) {
                    console.warn('Unable to parse church data string:', error);
                    return { ...CHURCH_DATA_DEFAULTS };
                }
            }

            const isValidObject = parsedData && typeof parsedData === 'object' && !Array.isArray(parsedData);
            if (!isValidObject) {
                return { ...CHURCH_DATA_DEFAULTS };
            }

            const normalized = {
                ...CHURCH_DATA_DEFAULTS,
                ...parsedData
            };

            if (!Array.isArray(normalized.weeklyEntries)) normalized.weeklyEntries = [];
            if (!Array.isArray(normalized.expenses)) normalized.expenses = [];
            if (!Array.isArray(normalized.monthlyArchives)) normalized.monthlyArchives = [];
            if (!Array.isArray(normalized.members)) normalized.members = [];
            if (!Array.isArray(normalized.monthlyTAMYAC)) normalized.monthlyTAMYAC = [];
            if (!Array.isArray(normalized.auditLog)) normalized.auditLog = [];

            if (!normalized.cumulativeDepartmentBalances || typeof normalized.cumulativeDepartmentBalances !== 'object' || Array.isArray(normalized.cumulativeDepartmentBalances)) {
                normalized.cumulativeDepartmentBalances = {};
            }

            const parsedBeginningBalance = Number(normalized.beginningBalance);
            normalized.beginningBalance = Number.isFinite(parsedBeginningBalance) ? parsedBeginningBalance : 0;

            if (typeof normalized.currentMonth !== 'string') normalized.currentMonth = '';
            if (typeof normalized.churchName !== 'string') normalized.churchName = '';

            return normalized;
        }

        let systemUsers = [];
        let currentLoggedInUser = null;

        const ALLOWED_EMAIL = 'yactreasury@gmail.com';
        const DISPLAY_GREETING = 'Hi, Krystal';
        const DEFAULT_ADMIN = {
            username: 'admin',
            password: 'admin321',
            fullName: 'Administrator',
            role: 'admin'
        };
        const FIXED_USERS = [];

        let editingEntryId = null;
        let entrySort = { key: 'date', dir: 'desc' };
        let autoSaveTimerId = null;
        const AUTO_SAVE_INTERVAL_MS = 300000;

        // ============ AUTHENTICATION SYSTEM ============
        
        function initializeAuthSystem() {
            // Load existing users from localStorage, or initialize with default admin account
            const savedUsers = localStorage.getItem('systemUsers');
            if (savedUsers) {
                try {
                    systemUsers = JSON.parse(savedUsers);
                    // Ensure admin account exists
                    if (!systemUsers.some(u => u.username === 'admin')) {
                        systemUsers.unshift(DEFAULT_ADMIN);
                        localStorage.setItem('systemUsers', JSON.stringify(systemUsers));
                    }
                } catch (e) {
                    // If parsing fails, reset to default admin
                    systemUsers = [DEFAULT_ADMIN];
                    localStorage.setItem('systemUsers', JSON.stringify(systemUsers));
                }
            } else {
                // First time - create with default admin account
                systemUsers = [DEFAULT_ADMIN];
                localStorage.setItem('systemUsers', JSON.stringify(systemUsers));
            }

            console.log('Auth System Initialized. Users:', systemUsers);

            const sessionUser = sessionStorage.getItem('currentUser');
            if (sessionUser) {
                currentLoggedInUser = JSON.parse(sessionUser);
                showMainApp();
            } else {
                showLoginScreen();
            }
        }

        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            console.log('Login attempt:', { username, systemUsers });

            const user = systemUsers.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentLoggedInUser = { username: user.username, fullName: user.fullName, role: user.role };
                sessionStorage.setItem('currentUser', JSON.stringify(currentLoggedInUser));
                loadData();
                addAuditLog('Logged in');
                showMainApp();
            } else {
                const errorDiv = document.getElementById('authError');
                errorDiv.textContent = 'Invalid username or password';
                errorDiv.classList.add('show');
            }
        }

        function handleSignup(event) {
            event.preventDefault();
            const firstName = document.getElementById('signupFirstName').value.trim();
            const surname = document.getElementById('signupSurname').value.trim();
            const username = document.getElementById('signupUsername').value.trim();
            const email = document.getElementById('signupEmail').value.trim().toLowerCase();
            const password = document.getElementById('signupPassword').value.trim();
            const confirmPassword = document.getElementById('signupConfirmPassword').value.trim();
            const errorDiv = document.getElementById('signupError');

            // Clear any existing errors
            errorDiv.classList.remove('show');

            // Check Gmail
            if (email !== ALLOWED_EMAIL) {
                errorDiv.textContent = `Only ${ALLOWED_EMAIL} is allowed.`;
                errorDiv.classList.add('show');
                return;
            }

            // Validation
            if (password !== confirmPassword) {
                errorDiv.textContent = `Passwords do not match (${password.length} vs ${confirmPassword.length} characters)`;
                errorDiv.classList.add('show');
                return;
            }

            if (password.length < 6) {
                errorDiv.textContent = 'Password must be at least 6 characters';
                errorDiv.classList.add('show');
                return;
            }

            if (systemUsers.some(u => u.username === username)) {
                errorDiv.textContent = 'Username already exists';
                errorDiv.classList.add('show');
                return;
            }

            // Create new user account with 'user' role (not admin)
            const newUser = {
                username: username,
                password: password,
                fullName: `${firstName} ${surname}`,
                firstName: firstName,
                surname: surname,
                role: 'user'
            };

            systemUsers.push(newUser);
            localStorage.setItem('systemUsers', JSON.stringify(systemUsers));

            // Automatically log in the new user
            currentLoggedInUser = { username: newUser.username, fullName: newUser.fullName, role: newUser.role };
            sessionStorage.setItem('currentUser', JSON.stringify(currentLoggedInUser));
            loadData();
            addAuditLog('Created new account and logged in');
            
            // Show success message briefly then go to main app
            alert('Account created successfully! Welcome to the Church Financial System.');
            showMainApp();
        }

        function toggleAuthForm() {
            const loginContainer = document.getElementById('loginFormContainer');
            const signupContainer = document.getElementById('signupFormContainer');
            
            if (loginContainer.style.display === 'none') {
                loginContainer.style.display = 'block';
                signupContainer.style.display = 'none';
                document.getElementById('signupForm').reset();
                document.getElementById('signupError').classList.remove('show');
            } else {
                loginContainer.style.display = 'none';
                signupContainer.style.display = 'block';
                document.getElementById('loginForm').reset();
                document.getElementById('authError').classList.remove('show');
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                addAuditLog('Logged out');
                currentLoggedInUser = null;
                sessionStorage.removeItem('currentUser');
                showLoginScreen();
            }
        }

        function showLoginScreen() {
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');
            if (loginScreen) {
                loginScreen.style.display = 'flex';
            }
            if (mainApp) {
                mainApp.style.display = 'none';
            }
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.reset();
            }
            const authError = document.getElementById('authError');
            if (authError) {
                authError.classList.remove('show');
            }
        }

        function showMainApp() {
            const loginScreen = document.getElementById('loginScreen');
            if (loginScreen) {
                loginScreen.style.display = 'none';
            }
            document.getElementById('mainApp').style.display = 'block';
            updateCurrentUserDisplay();
            
            // Show User Accounts tab only for admins
            const userAccountsTab = document.getElementById('userAccountsTab');
            if (userAccountsTab && currentLoggedInUser && currentLoggedInUser.role === 'admin') {
                userAccountsTab.style.display = 'inline-block';
            }
            
            init();
        }

        function updateCurrentUserDisplay() {
            const display = document.getElementById('currentUserDisplay');
            if (!display || !currentLoggedInUser) {
                return;
            }
            display.textContent = 'Hi, ' + currentLoggedInUser.username;
        }

        function addAuditLog(action) {
            if (!churchData.auditLog) {
                churchData.auditLog = [];
            }
            
            const logEntry = {
                timestamp: new Date().toISOString(),
                user: currentLoggedInUser ? currentLoggedInUser.fullName : 'System',
                action: action
            };
            
            churchData.auditLog.unshift(logEntry);
            
            // Keep only last 100 entries
            if (churchData.auditLog.length > 100) {
                churchData.auditLog = churchData.auditLog.slice(0, 100);
            }
            
            localStorage.setItem('churchFinancialData', JSON.stringify(churchData));
        }

        // User Management Functions (Disabled - users manage themselves via signup)
        function addUser(event) {
            event.preventDefault();
            alert('Users can create their own accounts on the login page.');
        }

        function deleteUser(username) {
            if (currentLoggedInUser.role !== 'admin') {
                alert('Only administrators can delete accounts');
                return;
            }
            if (username === 'admin') {
                alert('Cannot delete the admin account');
                return;
            }
            if (username === currentLoggedInUser.username) {
                alert('Cannot delete your own account');
                return;
            }
            if (confirm(`Are you sure you want to delete user: ${username}?`)) {
                systemUsers = systemUsers.filter(u => u.username !== username);
                localStorage.setItem('systemUsers', JSON.stringify(systemUsers));
                addAuditLog(`Deleted user: ${username}`);
                renderUsers();
            }
        }

        function renderUsers() {
            const tbody = document.getElementById('usersBody');
            if (!tbody) {
                return;
            }
            tbody.innerHTML = systemUsers.map((user, index) => `
                <tr>
                    <td>${user.username}</td>
                    <td><span class="role-badge admin">Data Entry</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-warning" onclick="openChangePasswordModal('${user.username}')">Change Password</button>
                            ${currentLoggedInUser.role === 'admin' && user.username !== currentLoggedInUser.username ? 
                                `<button class="btn btn-danger" onclick="deleteUser('${user.username}')">Delete</button>` : 
                                user.username === currentLoggedInUser.username ? '<span style="color: var(--text-light);">Your Account</span>' : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function togglePasswordView(index) {
            const pwdSpan = document.getElementById(`pwd-${index}`);
            const button = pwdSpan.nextElementSibling;
            
            if (pwdSpan.textContent === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
                pwdSpan.textContent = systemUsers[index].password;
                button.textContent = 'Hide';
            } else {
                pwdSpan.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                button.textContent = 'Show';
            }
        }

        function openChangePasswordModal(username) {
            // Set the username
            document.getElementById('changePasswordUsername').value = username;
            
            // Show modal
            document.getElementById('changePasswordModal').style.display = 'block';
            
            const errorDiv = document.getElementById('changePasswordError');
            
            // Reset error message
            errorDiv.classList.remove('show');
            errorDiv.style.background = '#fee2e2';
            errorDiv.style.borderColor = '#fecaca';
            errorDiv.style.color = '#991b1b';
            
            // Wait for modal to be fully rendered
            setTimeout(() => {
                // NOTE: IDs are swapped to work around browser focus bug
                // confirmNewPassword = first field (1Ô∏è‚É£), newPassword = second field (2Ô∏è‚É£)
                const field1 = document.getElementById('confirmNewPassword'); // First field (1Ô∏è‚É£)
                const field2 = document.getElementById('newPassword'); // Second field (2Ô∏è‚É£)
                
                console.log('Field setup - Field1 (1Ô∏è‚É£):', field1.id, 'Field2 (2Ô∏è‚É£):', field2.id);
                
                // Clear both fields aggressively
                field1.value = '';
                field2.value = '';
                field1.type = 'password';
                field2.type = 'password';
                
                // Remove any existing event listeners by replacing with clones
                const newField1 = field1.cloneNode(true);
                const newField2 = field2.cloneNode(true);
                field1.parentNode.replaceChild(newField1, field1);
                field2.parentNode.replaceChild(newField2, field2);
                
                // Get the ACTUAL new elements after replacement
                const actualField1 = document.getElementById('confirmNewPassword');
                const actualField2 = document.getElementById('newPassword');
                
                console.log('After clone - actualField1 (1Ô∏è‚É£):', actualField1.id, 'actualField2 (2Ô∏è‚É£):', actualField2.id);
                
                // Clear again
                actualField1.value = '';
                actualField2.value = '';
                
                // Add visual indicator to show which field is being typed in
                const addFieldIndicators = () => {
                    const val1 = actualField1.value;
                    const val2 = actualField2.value;
                    
                    // Add borders to show which field has content
                    if (val1) {
                        actualField1.style.borderColor = '#10b981';
                        actualField1.style.borderWidth = '2px';
                    } else {
                        actualField1.style.borderColor = '';
                        actualField1.style.borderWidth = '';
                    }
                    
                    if (val2) {
                        actualField2.style.borderColor = '#f59e0b';
                        actualField2.style.borderWidth = '2px';
                    } else {
                        actualField2.style.borderColor = '';
                        actualField2.style.borderWidth = '';
                    }
                    
                    console.log('Password check - Field1 (1Ô∏è‚É£): "' + val1 + '" (' + val1.length + ' chars), Field2 (2Ô∏è‚É£): "' + val2 + '" (' + val2.length + ' chars)');
                    
                    if (val1 && val2) {
                        if (val1 === val2) {
                            errorDiv.textContent = '‚úì Passwords match! (' + val1.length + ' characters)';
                            errorDiv.style.background = '#d1fae5';
                            errorDiv.style.borderColor = '#a7f3d0';
                            errorDiv.style.color = '#065f46';
                            errorDiv.classList.add('show');
                        } else {
                            errorDiv.textContent = '‚úó Not matching - Field1: ' + val1.length + ' chars, Field2: ' + val2.length + ' chars';
                            errorDiv.style.background = '#fef3c7';
                            errorDiv.style.borderColor = '#fcd34d';
                            errorDiv.style.color = '#92400e';
                            errorDiv.classList.add('show');
                        }
                    } else if (val1 || val2) {
                        errorDiv.textContent = '‚ö†Ô∏è Type in BOTH fields! Field1 (1Ô∏è‚É£): ' + val1.length + ' chars, Field2 (2Ô∏è‚É£): ' + val2.length + ' chars';
                        errorDiv.style.background = '#e0e7ff';
                        errorDiv.style.borderColor = '#c7d2fe';
                        errorDiv.style.color = '#3730a3';
                        errorDiv.classList.add('show');
                    } else {
                        errorDiv.classList.remove('show');
                    }
                };
                
                actualField1.addEventListener('input', addFieldIndicators);
                actualField2.addEventListener('input', addFieldIndicators);
                actualField1.addEventListener('keyup', addFieldIndicators);
                actualField2.addEventListener('keyup', addFieldIndicators);
                
                // Focus on field1
                actualField1.focus();
                setTimeout(() => actualField1.focus(), 50);
                
                // Log which field has focus
                setTimeout(() => {
                    console.log('Active element:', document.activeElement.id);
                }, 200);
                
            }, 200);
        }

        function openChangeMyPasswordModal() {
            if (!currentLoggedInUser) {
                alert('User not logged in');
                return;
            }
            document.getElementById('changePasswordUsername').value = currentLoggedInUser.username;
            document.getElementById('changePasswordModal').style.display = 'block';

            const errorDiv = document.getElementById('changePasswordError');
            errorDiv.classList.remove('show');
            errorDiv.textContent = '';

            setTimeout(() => {
                document.getElementById('confirmNewPassword').focus();
            }, 200);
        }

        function togglePasswordVisibility() {
            const checkbox = document.getElementById('showPasswordToggle');
            const field1 = document.getElementById('confirmNewPassword');
            const field2 = document.getElementById('newPassword');
            
            if (checkbox.checked) {
                field1.type = 'text';
                field2.type = 'text';
            } else {
                field1.type = 'password';
                field2.type = 'password';
            }
        }

        function closeChangePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            const errorDiv = document.getElementById('changePasswordError');
            
            modal.style.display = 'none';
            document.getElementById('changePasswordForm').reset();
            errorDiv.classList.remove('show');
            
            // Reset error styling
            errorDiv.style.background = '#fee2e2';
            errorDiv.style.borderColor = '#fecaca';
            errorDiv.style.color = '#991b1b';
            
            // Reset password fields to password type
            document.getElementById('newPassword').type = 'password';
            document.getElementById('confirmNewPassword').type = 'password';
            
            // Clear the fields explicitly
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
        }

        function handleChangePassword(event) {
            event.preventDefault();
            const username = document.getElementById('changePasswordUsername').value;
            
            // NOTE: IDs are swapped in HTML to work around browser focus issue
            // So we read them in reverse to get the correct logical order
            const field1Element = document.getElementById('confirmNewPassword'); // This is actually the FIRST field (1Ô∏è‚É£)
            const field2Element = document.getElementById('newPassword'); // This is actually the SECOND field (2Ô∏è‚É£)
            const password1 = field1Element.value.trim();
            const password2 = field2Element.value.trim();
            const errorDiv = document.getElementById('changePasswordError');

            // Reset error styling
            errorDiv.style.background = '#fee2e2';
            errorDiv.style.borderColor = '#fecaca';
            errorDiv.style.color = '#991b1b';

            // Comprehensive debug logging
            console.log('=== Password Change Submission ===');
            console.log('Username:', username);
            console.log('First field (1Ô∏è‚É£) value:', JSON.stringify(password1));
            console.log('First field length:', password1.length);
            console.log('Second field (2Ô∏è‚É£) value:', JSON.stringify(password2));
            console.log('Second field length:', password2.length);
            console.log('Are they equal?:', password1 === password2);

            // Check if both fields have values
            if (!password1 || !password2) {
                errorDiv.textContent = `Please fill both fields! First field has ${password1.length} chars, Second field has ${password2.length} chars`;
                errorDiv.classList.add('show');
                return;
            }

            // Check if passwords match
            if (password1 !== password2) {
                errorDiv.textContent = `Passwords do not match! First field: "${password1}" (${password1.length} chars), Second field: "${password2}" (${password2.length} chars)`;
                errorDiv.classList.add('show');
                console.error('MISMATCH - Field comparison failed');
                return;
            }

            // Check password length
            if (password1.length < 6) {
                errorDiv.textContent = 'Password must be at least 6 characters';
                errorDiv.classList.add('show');
                return;
            }

            // Find user and update password
            const user = systemUsers.find(u => u.username === username);
            if (user) {
                user.password = password1;
                localStorage.setItem('systemUsers', JSON.stringify(systemUsers));
                addAuditLog(`Changed password for user: ${username}`);
                closeChangePasswordModal();
                renderUsers();
                alert('Password changed successfully!');
            } else {
                errorDiv.textContent = 'User not found';
                errorDiv.classList.add('show');
            }
        }

        function togglePasswordVisibility() {
            const newPassword = document.getElementById('newPassword');
            const confirmPassword = document.getElementById('confirmNewPassword');
            const checkbox = document.getElementById('showPasswordToggle');
            
            const type = checkbox.checked ? 'text' : 'password';
            newPassword.type = type;
            confirmPassword.type = type;
        }

        function renderAuditLog() {
            if (!churchData.auditLog) {
                churchData.auditLog = [];
            }

            const tbody = document.getElementById('auditLogBody');
            if (churchData.auditLog.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty-state">No activity logged yet</td></tr>';
                return;
            }

            tbody.innerHTML = churchData.auditLog.map(log => {
                const date = new Date(log.timestamp);
                const formatted = date.toLocaleString();
                return `
                    <tr>
                        <td>${formatted}</td>
                        <td><strong>${log.user}</strong></td>
                        <td>${log.action}</td>
                    </tr>
                `;
            }).join('');
        }

        // ============ END AUTHENTICATION SYSTEM ============

        // Initialize application
        function init() {
            // Initialize Google Drive API
            initGoogleDrive();
            
            // Restore Google Drive file ID if exists
            googleDriveFileId = localStorage.getItem('googleDriveFileId');
            sharedDriveFileId = localStorage.getItem('sharedGoogleDriveFileId');
            updateSharedFileUI();
            
            // Restore cloud sync state if it was previously enabled
            const wasSyncEnabled = localStorage.getItem('cloudSyncEnabled') === 'true';
            if (wasSyncEnabled) {
                cloudRole = getCloudRole();
                // Restore token from localStorage
                const savedToken = localStorage.getItem('googleAccessToken');
                const savedExpiry = localStorage.getItem('googleTokenExpiresAt');
                
                if (savedToken && savedExpiry) {
                    accessToken = savedToken;
                    tokenExpiresAt = parseInt(savedExpiry, 10);
                    
                    // Wait for Google API to initialize, then check if token is still valid
                    setTimeout(() => {
                        if (isTokenValid()) {
                            gapi.client.setToken({ access_token: accessToken });
                            cloudSyncEnabled = true;
                            currentUser = { name: getCloudLabel(cloudRole) };
                            updateCloudSyncUI();
                            console.log('‚úÖ Cloud Sync restored from previous session');
                        } else {
                            // Token expired - clear everything
                            localStorage.removeItem('cloudSyncEnabled');
                            localStorage.removeItem('googleAccessToken');
                            localStorage.removeItem('googleTokenExpiresAt');
                            console.log('‚ÑπÔ∏è Cloud Sync was enabled but token expired. Please re-enable.');
                        }
                    }, 1000); // Wait for Google API to initialize
                }
            }
            
            loadData();

            startAutoSave();
            
            // CRITICAL: Ensure members array is never undefined
            if (!churchData.members || !Array.isArray(churchData.members)) {
                churchData.members = [];
            }
            
            // Set current month
            const now = new Date();
            if (!churchData.currentMonth) {
                churchData.currentMonth = now.toISOString().substring(0, 7);
            }
            
            document.getElementById('monthSelector').value = churchData.currentMonth;
            document.getElementById('churchName').value = churchData.churchName || "";
            
            // Set today's date
            document.getElementById('entryDate').valueAsDate = now;
            document.getElementById('expenseDate').valueAsDate = now;
            
            // Generate receipt number
            generateReceiptNumber();
            
            // Populate department dropdowns
            populateDepartmentDropdowns();
            
            // Update member list
            updateMemberList();
            
            // Render all views
            renderAllViews();
        }

        function startAutoSave() {
            if (autoSaveTimerId) return;
            autoSaveTimerId = setInterval(() => {
                saveData(true);
            }, AUTO_SAVE_INTERVAL_MS);
        }

        // Save Data - Preserves all data including members & syncs to cloud
        function saveData(silent = false) {
            // CRITICAL: Always preserve members data
            if (!churchData.members) {
                churchData.members = [];
            }
            
            // Save to local storage
            localStorage.setItem('churchFinancialData', JSON.stringify(churchData));
            console.log('üíæ Data saved to localStorage');
            
            // Sync to Google Drive if enabled
            if (cloudSyncEnabled && currentUser) {
                console.log('‚òÅÔ∏è Triggering Google Drive sync...');
                syncToGoogleDrive();
            } else {
                console.log('‚ö†Ô∏è Cloud sync not triggered. cloudSyncEnabled:', cloudSyncEnabled, 'currentUser:', currentUser);
            }
            
            if (!silent) {
                alert('Data saved successfully!');
            }
        }

        // Load Data - Preserve All Data Including Members Across All Months
        function loadData() {
            // Fall back to local storage (cloud sync is handled separately in updateSignInStatus)
            const saved = localStorage.getItem('churchFinancialData');
            if (saved) {
                try {
                    const savedData = JSON.parse(saved);
                    churchData = normalizeChurchData(savedData);
                } catch (error) {
                    console.warn('Failed to parse local church data. Resetting to defaults.', error);
                    churchData = normalizeChurchData(null);
                }
            }
        }

        // Cloud Sync Functions
        async function toggleCloudSync() {
            if (isFileProtocol()) {
                setGoogleDriveInitStatus('init-status-error', 'Google API: unavailable on file://. Use http://localhost:8000');
                alert('Cloud Sync requires http(s). Open the app via http://localhost:8000 instead of file://.');
                return;
            }
            if (!(await ensureGoogleDriveReady())) {
                const origin = window.location.origin || 'your server URL';
                alert(`Google API failed to initialize. Open the app via http://localhost:8000 (not file://), confirm internet access, and add your origin (${origin}) in Google Cloud OAuth settings.`);
                return;
            }

            cloudRole = getCloudRole();

            if (cloudSyncEnabled) {
                // Disable cloud sync
                if (accessToken && window.google && google.accounts && google.accounts.oauth2) {
                    google.accounts.oauth2.revoke(accessToken, () => {});
                }
                accessToken = null;
                tokenExpiresAt = 0;
                gapi.client.setToken(null);
                cloudSyncEnabled = false;
                currentUser = null;
                googleDriveFileId = null;
                localStorage.removeItem('googleDriveFileId');
                localStorage.removeItem('cloudSyncEnabled');
                localStorage.removeItem('googleAccessToken');
                localStorage.removeItem('googleTokenExpiresAt');
                updateCloudSyncUI();
                alert('Cloud sync disabled. Using local storage only.');
            } else {
                // Enable cloud sync - prompt OAuth
                const signedIn = await ensureAccessToken(cloudRole);
                if (signedIn) {
                    localStorage.setItem('cloudSyncEnabled', 'true');
                    loadFromGoogleDrive();
                }
            }
        }

        async function disconnectCloudSync() {
            cloudRole = getCloudRole();

            if (!cloudSyncEnabled) {
                return;
            }

            if (!confirm('Disconnect Google Drive for this role?')) {
                return;
            }

            try {
                if (accessToken && window.google && google.accounts && google.accounts.oauth2) {
                    google.accounts.oauth2.revoke(accessToken, () => {});
                }
                accessToken = null;
                tokenExpiresAt = 0;
                gapi.client.setToken(null);
                cloudSyncEnabled = false;
                currentUser = null;
                googleDriveFileId = null;
                localStorage.removeItem('googleDriveFileId');
                localStorage.removeItem('cloudSyncEnabled');
                localStorage.removeItem('googleAccessToken');
                localStorage.removeItem('googleTokenExpiresAt');
                updateCloudSyncUI();
                alert('Cloud sync disconnected.');
            } catch (error) {
                console.error('Cloud disconnect error:', error);
                alert('Cloud disconnect failed. Please try again.');
            }
        }

        async function syncToGoogleDrive() {
            cloudRole = getCloudRole();
            console.log('üîÑ syncToGoogleDrive called', { cloudSyncEnabled, currentUser, googleDriveFileId, sharedDriveFileId });
            
            if (!cloudSyncEnabled || !currentUser) {
                console.warn('‚ö†Ô∏è Sync skipped: cloudSyncEnabled =', cloudSyncEnabled, ', currentUser =', currentUser);
                return;
            }

            if (sharedDriveFileId && sharedFileCanEdit === false) {
                if (!sharedSyncReadOnlyWarnShown) {
                    alert('Shared file is read-only for this account/app, so changes cannot be saved to it. Ask the owner for Editor access or clear Shared ID to use your own Drive file.');
                    sharedSyncReadOnlyWarnShown = true;
                }
                return;
            }

            try {
                // Include both data and users in the sync
                const dataToSync = {
                    data: churchData,
                    users: systemUsers
                };
                const fileContent = JSON.stringify(dataToSync, null, 2);
                console.log('üìù File content size:', fileContent.length, 'bytes');
                console.log('üìù Including users:', systemUsers.length, 'user accounts');
                
                const boundary = '-------314159265358979323846';
                const delimiter = "\r\n--" + boundary + "\r\n";
                const close_delim = "\r\n--" + boundary + "--";
                
                if (sharedDriveFileId) {
                    console.log('üîÑ Updating shared file:', sharedDriveFileId);
                    
                    const multipartRequestBody =
                        delimiter +
                        'Content-Type: application/json\r\n\r\n' +
                        JSON.stringify({}) +
                        delimiter +
                        'Content-Type: application/json\r\n\r\n' +
                        fileContent +
                        close_delim;

                    console.log('üì§ Multipart body size:', multipartRequestBody.length, 'bytes');
                    
                    const request = gapi.client.request({
                        'path': '/upload/drive/v3/files/' + sharedDriveFileId,
                        'method': 'PATCH',
                        'params': {'uploadType': 'multipart', 'supportsAllDrives': true},
                        'headers': {
                            'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                        },
                        'body': multipartRequestBody
                    });
                    
                    const response = await request;
                    console.log('‚úÖ Shared file updated', response);
                    googleDriveFileId = sharedDriveFileId;
                } else if (googleDriveFileId) {
                    // Update existing file
                    console.log('üîÑ Updating file:', googleDriveFileId);
                    
                    const multipartRequestBody =
                        delimiter +
                        'Content-Type: application/json\r\n\r\n' +
                        JSON.stringify({}) +
                        delimiter +
                        'Content-Type: application/json\r\n\r\n' +
                        fileContent +
                        close_delim;

                    console.log('üì§ Multipart body size:', multipartRequestBody.length, 'bytes');
                    
                    const request = gapi.client.request({
                        'path': '/upload/drive/v3/files/' + googleDriveFileId,
                        'method': 'PATCH',
                        'params': {'uploadType': 'multipart'},
                        'headers': {
                            'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                        },
                        'body': multipartRequestBody
                    });
                    
                    const response = await request;
                    console.log('‚úÖ File updated', response);
                } else {
                    // Create new file
                    console.log('üìÅ Creating new Google Drive file:', FILE_NAME);
                    
                    const metadata = {
                        'name': FILE_NAME,
                        'mimeType': 'application/json'
                    };
                    
                    const multipartRequestBody =
                        delimiter +
                        'Content-Type: application/json\r\n\r\n' +
                        JSON.stringify(metadata) +
                        delimiter +
                        'Content-Type: application/json\r\n\r\n' +
                        fileContent +
                        close_delim;

                    console.log('üì§ Multipart body size:', multipartRequestBody.length, 'bytes');
                    
                    const request = gapi.client.request({
                        'path': '/upload/drive/v3/files',
                        'method': 'POST',
                        'params': {'uploadType': 'multipart', 'fields': 'id'},
                        'headers': {
                            'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                        },
                        'body': multipartRequestBody
                    });
                    
                    const response = await request;
                    googleDriveFileId = response.result.id;
                    console.log('‚úÖ File created successfully! File ID:', googleDriveFileId, 'Response:', response);
                    // Save file ID to localStorage for future syncs
                    localStorage.setItem('googleDriveFileId', googleDriveFileId);
                    alert(`File created in Google Drive!\n\nFile ID: ${googleDriveFileId}\n\nFile Name: ${FILE_NAME}\n\nYou can now find this file in your Google Drive.`);
                }
                
                console.log('‚úÖ Synced to Google Drive successfully');
            } catch (error) {
                console.error('‚ùå Google Drive sync error:', error);
                console.error('Error details:', JSON.stringify(error, null, 2));
                console.error('Error message:', error.message);
                console.error('Error code:', error.code);
                if (sharedDriveFileId) {
                    const errorMessage = (error && error.result && error.result.error && error.result.error.message) || error.message || '';
                    const isPermissionError = /permission|insufficient|forbidden|not found|404|403|cannotShareAcrossDomains/i.test(errorMessage);
                    if (isPermissionError) {
                        sharedFileCanEdit = false;
                        updateSharedFileUI();
                        alert('Shared file sync failed: this account/app cannot edit that file. Ask the owner to grant Editor access, or clear Shared ID and use your own Drive file.');
                    } else {
                        alert(`Shared file sync failed: ${errorMessage || 'Unknown error'}`);
                    }
                }
            }
        }

        async function loadFromGoogleDrive() {
            cloudRole = getCloudRole();
            if (!cloudSyncEnabled || !currentUser) return;

            try {
                if (sharedDriveFileId) {
                    const fileContent = await gapi.client.drive.files.get({
                        fileId: sharedDriveFileId,
                        supportsAllDrives: true,
                        alt: 'media'
                    });

                    googleDriveFileId = sharedDriveFileId;
                    
                    // Handle both new format (with users) and old format (data only)
                    if (fileContent.result.data && fileContent.result.users) {
                        // New format with users
                        churchData = normalizeChurchData(fileContent.result.data);
                        systemUsers = fileContent.result.users || [];
                        localStorage.setItem('systemUsers', JSON.stringify(systemUsers));
                        console.log('‚úÖ Loaded users from Google Drive:', systemUsers.length, 'accounts');
                    } else {
                        // Old format - just data
                        churchData = normalizeChurchData(fileContent.result);
                    }

                    try {
                        const fileMeta = await gapi.client.drive.files.get({
                            fileId: sharedDriveFileId,
                            fields: 'capabilities(canEdit)',
                            supportsAllDrives: true
                        });
                        sharedFileCanEdit = Boolean(fileMeta && fileMeta.result && fileMeta.result.capabilities && fileMeta.result.capabilities.canEdit);
                        sharedSyncReadOnlyWarnShown = false;
                        updateSharedFileUI();
                    } catch (metaError) {
                        console.warn('Unable to read shared file capabilities:', metaError);
                        sharedFileCanEdit = null;
                        updateSharedFileUI();
                    }
                    
                    // Reload the UI with cloud data
                    renderAllViews();
                    
                    console.log('Loaded from Google Drive (shared file)');
                    return;
                }

                // Find existing file
                const response = await gapi.client.drive.files.list({
                    q: `name='${FILE_NAME}' and trashed=false`,
                    spaces: 'drive',
                    fields: 'files(id, name)',
                    pageSize: 1
                });
                
                const files = response.result.files;
                if (files && files.length > 0) {
                    googleDriveFileId = files[0].id;
                    // Save file ID to localStorage for future syncs
                    localStorage.setItem('googleDriveFileId', googleDriveFileId);
                    
                    // Download file content
                    const fileContent = await gapi.client.drive.files.get({
                        fileId: googleDriveFileId,
                        alt: 'media'
                    });
                    
                    // Handle both new format (with users) and old format (data only)
                    if (fileContent.result.data && fileContent.result.users) {
                        // New format with users
                        churchData = normalizeChurchData(fileContent.result.data);
                        systemUsers = fileContent.result.users || [];
                        localStorage.setItem('systemUsers', JSON.stringify(systemUsers));
                        console.log('‚úÖ Loaded users from Google Drive:', systemUsers.length, 'accounts');
                    } else {
                        // Old format - just data
                        churchData = normalizeChurchData(fileContent.result);
                    }
                    
                    // Reload the UI with cloud data
                    renderAllViews();
                    
                    console.log('Loaded from Google Drive');
                }
            } catch (error) {
                console.error('Google Drive load error:', error);
                if (sharedDriveFileId) {
                    const errorMessage = (error && error.result && error.result.error && error.result.error.message) || error.message || '';
                    const isPermissionError = /permission|insufficient|forbidden|not found|404|403/i.test(errorMessage);
                    if (isPermissionError) {
                        alert('Shared file load failed. Confirm the file is shared with this Google account.');
                    } else {
                        alert('Shared file load failed. The selected file is not valid Church Finance JSON data.');
                    }
                }
            }
        }

        function updateCloudSyncUI() {
            const btn = document.getElementById('cloudSyncBtn');
            const status = document.getElementById('cloudSyncStatus');
            const disconnectBtn = document.getElementById('cloudDisconnectBtn');

            if (isFileProtocol()) {
                btn.textContent = 'Cloud Sync Unavailable';
                btn.className = 'btn btn-secondary';
                btn.disabled = true;
                btn.title = 'Cloud Sync requires http(s). Open via http://localhost:8000.';
                status.className = 'status-disabled';
                status.textContent = 'Local only (file://)';
                if (disconnectBtn) {
                    disconnectBtn.style.display = 'none';
                }
                updateSharedFileUI();
                return;
            }

            btn.disabled = false;
            btn.title = '';
            
            if (cloudSyncEnabled && currentUser) {
                btn.textContent = 'Cloud Sync Enabled';
                btn.className = 'btn btn-danger';
                status.className = 'status-enabled';
                status.textContent = `Synced: ${currentUser.name}`;
                if (disconnectBtn) {
                    disconnectBtn.style.display = 'inline-flex';
                }
            } else {
                btn.textContent = 'Enable Cloud Sync';
                btn.className = 'btn btn-success';
                status.className = 'status-disabled';
                status.textContent = 'Not connected';
                if (disconnectBtn) {
                    disconnectBtn.style.display = 'none';
                }
            }

            updateSharedFileUI();
        }

        function updateSharedFileUI() {
            const input = document.getElementById('sharedFileIdInput');
            const status = document.getElementById('sharedFileStatus');
            if (!input || !status) {
                return;
            }

            input.value = sharedDriveFileId || '';
            if (sharedDriveFileId) {
                if (sharedFileCanEdit === false) {
                    status.className = 'status-disabled';
                    status.textContent = 'Shared file set (read-only)';
                } else if (sharedFileCanEdit === true) {
                    status.className = 'status-enabled';
                    status.textContent = 'Shared file ID set (editable)';
                } else {
                    status.className = 'status-enabled';
                    status.textContent = 'Shared file ID set';
                }
            } else {
                status.className = 'status-disabled';
                status.textContent = 'No shared file ID';
            }
        }

        function extractDriveFileId(value) {
            if (!value) {
                return '';
            }

            if (!value.includes('/') && !value.includes('?') && !value.includes('&')) {
                return value;
            }

            try {
                const url = new URL(value);
                const idFromQuery = url.searchParams.get('id') || url.searchParams.get('fileId');
                if (idFromQuery) {
                    return idFromQuery;
                }
                const match = url.pathname.match(/\/d\/([a-zA-Z0-9_-]+)/);
                if (match) {
                    return match[1];
                }
            } catch (error) {
                const match = value.match(/\/d\/([a-zA-Z0-9_-]+)/) || value.match(/[?&]id=([a-zA-Z0-9_-]+)/);
                if (match) {
                    return match[1];
                }
            }

            return '';
        }

        function setSharedDriveFileId() {
            const input = document.getElementById('sharedFileIdInput');
            if (!input) {
                return;
            }

            const value = input.value.trim();
            if (!value) {
                alert('Enter a shared Drive file ID, or use Clear ID.');
                return;
            }

            const extractedId = extractDriveFileId(value);
            if (!extractedId) {
                alert('Could not find a Drive file ID. Paste the file ID or a full Drive link.');
                return;
            }

            sharedDriveFileId = extractedId;
            sharedFileCanEdit = null;
            sharedSyncReadOnlyWarnShown = false;
            input.value = extractedId;
            localStorage.setItem('sharedGoogleDriveFileId', sharedDriveFileId);
            updateSharedFileUI();

            if (cloudSyncEnabled && currentUser) {
                loadFromGoogleDrive();
            }
        }

        function clearSharedDriveFileId() {
            if (!sharedDriveFileId) {
                return;
            }

            if (!confirm('Clear the shared file ID for this device?')) {
                return;
            }

            sharedDriveFileId = null;
            sharedFileCanEdit = null;
            sharedSyncReadOnlyWarnShown = false;
            localStorage.removeItem('sharedGoogleDriveFileId');
            updateSharedFileUI();
        }

        function saveChurchName() {
            churchData.churchName = document.getElementById('churchName').value;
            saveData(true);
        }

        // Tab switching
        function switchTab(index) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            tabs[index].classList.add('active');
            contents[index].classList.add('active');
            
            // Render the active tab content
            renderAllViews();
        }

        // Generate receipt number
        function generateReceiptNumber() {
            document.getElementById('receiptNumber').value = '';
        }

        // Populate department dropdowns
        function populateDepartmentDropdowns() {
            const expenseDept = document.getElementById('expenseDepartment');
            const filterDept = document.getElementById('expenseFilterDept');
            
            expenseDept.innerHTML = '';
            filterDept.innerHTML = '<option value="">All Departments</option>';
            
            departments.forEach(dept => {
                expenseDept.innerHTML += `<option>${dept.name}</option>`;
                filterDept.innerHTML += `<option>${dept.name}</option>`;
            });
            
            // Add designated categories
            designatedCategories.forEach(cat => {
                expenseDept.innerHTML += `<option>${cat}</option>`;
                filterDept.innerHTML += `<option>${cat}</option>`;
            });
        }

        // Add or update weekly entry
        function addWeeklyEntry(event) {
            event.preventDefault();

            const entryDate = document.getElementById('entryDate').value;
            const memberName = document.getElementById('memberName').value.trim();
            if (!entryDate) {
                alert('Date is required.');
                return;
            }
            if (!memberName) {
                alert('Member name is required.');
                return;
            }

            const receiptNumber = document.getElementById('receiptNumber').value.trim();
            if (receiptNumber) {
                const duplicateReceipt = churchData.weeklyEntries.some(e =>
                    e.receiptNumber === receiptNumber &&
                    e.id !== editingEntryId &&
                    e.date.substring(0, 7) === churchData.currentMonth
                );
                if (duplicateReceipt) {
                    alert('Duplicate receipt number found in this month. Please use a unique receipt number.');
                    return;
                }
            }
            
            const entry = {
                id: editingEntryId || Date.now().toString(),
                date: entryDate,
                receiptNumber: receiptNumber,
                memberName: memberName,
                tithes: parseFloat(document.getElementById('tithes').value) || 0,
                sharedOfferings: {
                    oneFund: parseFloat(document.getElementById('oneFund').value) || 0,
                    special: parseFloat(document.getElementById('specialOffering').value) || 0,
                    churchOffering: parseFloat(document.getElementById('churchOffering').value) || 0,
                    sabbathSchool: parseFloat(document.getElementById('sabbathSchoolOffering').value) || 0
                },
                designatedOfferings: {
                    childrenSS: parseFloat(document.getElementById('childrenSS').value) || 0,
                    ayProject: parseFloat(document.getElementById('ayProject').value) || 0,
                    churchExpense: parseFloat(document.getElementById('churchExpense').value) || 0,
                    potluck: parseFloat(document.getElementById('potluck').value) || 0,
                    other: parseFloat(document.getElementById('otherDonation').value) || 0,
                    childrenOutreach: parseFloat(document.getElementById('childrenOutreach').value) || 0,
                    ayOutreach: parseFloat(document.getElementById('ayOutreach').value) || 0,
                    churchFund: parseFloat(document.getElementById('churchFund').value) || 0,
                    churchCommunity: parseFloat(document.getElementById('churchCommunity').value) || 0
                }
            };
            
            if (editingEntryId) {
                const index = churchData.weeklyEntries.findIndex(e => e.id === editingEntryId);
                if (index !== -1) {
                    churchData.weeklyEntries[index] = entry;
                }
                addAuditLog(`Updated collection entry for ${memberName} on ${entryDate}`);
            } else {
                churchData.weeklyEntries.push(entry);
                addAuditLog(`Added collection entry for ${memberName} on ${entryDate}`);
            }
            saveData(true);
            
            resetEntryForm({ keepReceipt: true });
            
            renderAllViews();
            const entryMonth = entryDate.substring(0, 7);
            if (entryMonth !== churchData.currentMonth) {
                alert(editingEntryId
                    ? 'Entry updated successfully! This entry belongs to a different month; switch the month selector to view it.'
                    : 'Entry added successfully! This entry belongs to a different month; switch the month selector to view it.'
                );
            } else {
                alert(editingEntryId ? 'Entry updated successfully!' : 'Entry added successfully!');
            }
        }

        function editEntry(id) {
            const entry = churchData.weeklyEntries.find(e => e.id === id);
            if (!entry) {
                return;
            }

            editingEntryId = id;
            document.getElementById('entryDate').value = entry.date;
            document.getElementById('receiptNumber').value = entry.receiptNumber;
            document.getElementById('memberName').value = entry.memberName;
            document.getElementById('tithes').value = entry.tithes;

            document.getElementById('oneFund').value = entry.sharedOfferings.oneFund;
            document.getElementById('specialOffering').value = entry.sharedOfferings.special;
            document.getElementById('churchOffering').value = entry.sharedOfferings.churchOffering;
            document.getElementById('sabbathSchoolOffering').value = entry.sharedOfferings.sabbathSchool;

            document.getElementById('childrenSS').value = entry.designatedOfferings.childrenSS;
            document.getElementById('ayProject').value = entry.designatedOfferings.ayProject;
            document.getElementById('churchExpense').value = entry.designatedOfferings.churchExpense;
            document.getElementById('potluck').value = entry.designatedOfferings.potluck;
            document.getElementById('otherDonation').value = entry.designatedOfferings.other;
            document.getElementById('childrenOutreach').value = entry.designatedOfferings.childrenOutreach;
            document.getElementById('ayOutreach').value = entry.designatedOfferings.ayOutreach;
            document.getElementById('churchFund').value = entry.designatedOfferings.churchFund;
            document.getElementById('churchCommunity').value = entry.designatedOfferings.churchCommunity;

            document.getElementById('entrySubmitButton').textContent = 'üíæ Update Entry';
            document.getElementById('entryCancelButton').style.display = 'inline-block';
            document.getElementById('entryForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function cancelEditEntry() {
            resetEntryForm();
        }

        function resetEntryForm(options = {}) {
            const keepReceipt = options.keepReceipt === true;
            const receiptValue = document.getElementById('receiptNumber').value;
            editingEntryId = null;
            document.getElementById('entryForm').reset();
            document.getElementById('entryDate').valueAsDate = new Date();
            if (keepReceipt) {
                document.getElementById('receiptNumber').value = receiptValue;
            } else {
                generateReceiptNumber();
            }
            document.getElementById('entrySubmitButton').textContent = '‚ûï Add Entry';
            document.getElementById('entryCancelButton').style.display = 'none';
        }

        // Delete entry
        function deleteEntry(id) {
            if (confirm('Are you sure you want to delete this entry?')) {
                const entry = churchData.weeklyEntries.find(e => e.id === id);
                churchData.weeklyEntries = churchData.weeklyEntries.filter(e => e.id !== id);
                addAuditLog(`Deleted collection entry for ${entry ? entry.memberName : 'Unknown'}`);
                saveData(true);
                renderAllViews();
                alert('Entry deleted successfully!');
            }
        }

        // Add expense
        function addExpense(event) {
            event.preventDefault();
            
            const expense = {
                id: Date.now().toString(),
                date: document.getElementById('expenseDate').value,
                department: document.getElementById('expenseDepartment').value,
                description: document.getElementById('expenseDescription').value,
                amount: parseFloat(document.getElementById('expenseAmount').value),
                type: document.getElementById('expenseType').value,
                reference: document.getElementById('expenseReference').value || ""
            };
            
            churchData.expenses.push(expense);
            addAuditLog(`Added expense: ${expense.description} (${expense.department}) - ${formatCurrency(expense.amount)}`);
            saveData(true);
            
            document.getElementById('expenseForm').reset();
            document.getElementById('expenseDate').valueAsDate = new Date();
            
            renderAllViews();
            alert('Expense recorded successfully!');
        }

        // Modal functions
        function openExpenseModal(department) {
            document.getElementById('modalDepartment').value = department;
            document.getElementById('modalExpenseDate').valueAsDate = new Date();
            document.getElementById('expenseModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('expenseModal').style.display = 'none';
            document.getElementById('modalExpenseForm').reset();
        }

        function addModalExpense(event) {
            event.preventDefault();
            
            const expense = {
                id: Date.now().toString(),
                date: document.getElementById('modalExpenseDate').value,
                department: document.getElementById('modalDepartment').value,
                description: document.getElementById('modalExpenseDescription').value,
                amount: parseFloat(document.getElementById('modalExpenseAmount').value),
                type: "Expense",
                reference: document.getElementById('modalExpenseReference').value || ""
            };
            
            churchData.expenses.push(expense);
            saveData(true);
            
            closeModal();
            renderAllViews();
            alert('Expense added successfully!');
        }

        // Delete expense
        function deleteExpense(id) {
            if (confirm('Are you sure you want to delete this expense?')) {
                const expense = churchData.expenses.find(e => e.id === id);
                churchData.expenses = churchData.expenses.filter(e => e.id !== id);
                addAuditLog(`Deleted expense: ${expense ? expense.description : 'Unknown'}`);
                saveData(true);
                renderAllViews();
                alert('‚úÖ Expense deleted successfully!');
            }
        }

        // Format currency
        function formatCurrency(amount) {
            return '‡∏ø' + amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        function formatLocalDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getWeekRange(dateStr) {
            const date = new Date(`${dateStr}T00:00:00`);
            const dayOfWeek = date.getDay();
            const start = new Date(date);
            start.setDate(date.getDate() - dayOfWeek);
            const end = new Date(start);
            end.setDate(start.getDate() + 6);
            return { start, end };
        }

        function getFirstSaturdayOfMonth(monthStr) {
            const parts = monthStr.split('-').map(Number);
            const firstDay = new Date(Date.UTC(parts[0], parts[1] - 1, 1));
            const dayOfWeek = firstDay.getUTCDay();
            const offset = (6 - dayOfWeek + 7) % 7;
            firstDay.setUTCDate(firstDay.getUTCDate() + offset);
            return firstDay;
        }

        function getWeekNumberForMonth(dateStr, monthStr) {
            const dateParts = dateStr.split('-').map(Number);
            const date = new Date(Date.UTC(dateParts[0], dateParts[1] - 1, dateParts[2]));

            // Week ends on Saturday (Sabbath)
            const dayOfWeek = date.getUTCDay();
            const toSaturday = (6 - dayOfWeek + 7) % 7;
            const weekEnd = new Date(date);
            weekEnd.setUTCDate(weekEnd.getUTCDate() + toSaturday);

            const firstSaturday = getFirstSaturdayOfMonth(monthStr);
            if (weekEnd < firstSaturday) {
                return 1;
            }

            const diffDays = Math.floor((weekEnd - firstSaturday) / 86400000);
            return Math.floor(diffDays / 7) + 1;
        }

        // Calculate totals
        function calculateTotals() {
            const currentEntries = churchData.weeklyEntries.filter(e => 
                e.date.substring(0, 7) === churchData.currentMonth
            );
            
            const currentExpenses = churchData.expenses.filter(e => 
                e.date.substring(0, 7) === churchData.currentMonth
            );
            
            // Calculate total tithes
            const totalTithes = currentEntries.reduce((sum, e) => sum + e.tithes, 0);
            
            // Calculate total shared offerings
            const totalSharedOfferings = currentEntries.reduce((sum, e) => {
                return sum + e.sharedOfferings.oneFund + e.sharedOfferings.special + 
                       e.sharedOfferings.churchOffering + e.sharedOfferings.sabbathSchool;
            }, 0);
            
            // Calculate mission and local shares
            const missionShare = totalSharedOfferings * 0.55;
            const localShare = totalSharedOfferings * 0.45;
            
            // Calculate Church Fund separately (to be added to department pool)
            const churchFundAmount = currentEntries.reduce((sum, e) => {
                return sum + (e.designatedOfferings.churchFund || 0);
            }, 0);
            
            // Calculate designated offerings
            const totalDesignated = currentEntries.reduce((sum, e) => {
                return sum + e.designatedOfferings.childrenSS + e.designatedOfferings.ayProject + 
                       e.designatedOfferings.churchExpense + e.designatedOfferings.potluck + 
                       e.designatedOfferings.other + e.designatedOfferings.childrenOutreach +
                       e.designatedOfferings.ayOutreach + e.designatedOfferings.churchFund +
                       e.designatedOfferings.churchCommunity;
            }, 0);
            
            // Calculate total receipts
            const totalReceipts = totalTithes + totalSharedOfferings + totalDesignated;
            
            // Calculate total expenses
            const totalExpenses = currentExpenses.reduce((sum, e) => sum + e.amount, 0);
            
            return {
                totalTithes,
                totalSharedOfferings,
                missionShare,
                localShare,
                totalDesignated,
                churchFundAmount,
                totalReceipts,
                totalExpenses,
                currentEntries,
                currentExpenses
            };
        }

        // Render entries table
        function renderEntries() {
            const tbody = document.getElementById('entriesBody');
            const currentEntries = churchData.weeklyEntries.filter(e => 
                e.date.substring(0, 7) === churchData.currentMonth
            );
            
            if (currentEntries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No entries for this month</td></tr>';
                return;
            }

            const enrichedEntries = currentEntries.map(entry => {
                const sharedTotal = Object.values(entry.sharedOfferings).reduce((a, b) => a + b, 0);
                const designatedTotal = Object.values(entry.designatedOfferings).reduce((a, b) => a + b, 0);
                const entryTotal = entry.tithes + sharedTotal + designatedTotal;
                return { entry, sharedTotal, designatedTotal, entryTotal };
            });

            const dirFactor = entrySort.dir === 'asc' ? 1 : -1;
            enrichedEntries.sort((a, b) => {
                const av = getEntrySortValue(a, entrySort.key);
                const bv = getEntrySortValue(b, entrySort.key);

                if (typeof av === 'string') {
                    return av.localeCompare(bv) * dirFactor;
                }
                if (av < bv) {
                    return -1 * dirFactor;
                }
                if (av > bv) {
                    return 1 * dirFactor;
                }
                return 0;
            });

            tbody.innerHTML = enrichedEntries.map(item => {
                const entry = item.entry;
                const sharedTotal = item.sharedTotal;
                const designatedTotal = item.designatedTotal;
                const entryTotal = item.entryTotal;

                return `
                    <tr>
                        <td>${entry.date}</td>
                        <td class="receipt-num">${entry.receiptNumber}</td>
                        <td>${entry.memberName}</td>
                        <td class="currency">${formatCurrency(entry.tithes)}</td>
                        <td class="currency">${formatCurrency(sharedTotal)}</td>
                        <td class="currency">${formatCurrency(designatedTotal)}</td>
                        <td class="currency"><strong>${formatCurrency(entryTotal)}</strong></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-warning" onclick="editEntry('${entry.id}')">‚úèÔ∏è</button>
                                <button class="btn btn-danger" onclick="deleteEntry('${entry.id}')">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function setEntrySort(key) {
            if (entrySort.key === key) {
                entrySort.dir = entrySort.dir === 'asc' ? 'desc' : 'asc';
            } else {
                entrySort.key = key;
                entrySort.dir = key === 'date' ? 'desc' : 'asc';
            }
            renderEntries();
        }

        function getEntrySortValue(item, key) {
            const entry = item.entry;
            switch (key) {
                case 'date':
                    return new Date(entry.date);
                case 'receipt':
                    return entry.receiptNumber || '';
                case 'member':
                    return entry.memberName || '';
                case 'tithes':
                    return entry.tithes || 0;
                case 'shared':
                    return item.sharedTotal || 0;
                case 'designated':
                    return item.designatedTotal || 0;
                case 'total':
                    return item.entryTotal || 0;
                default:
                    return new Date(entry.date);
            }
        }

        // Render departments
        function renderDepartments() {
            const totals = calculateTotals();
            // Add Church Fund to the department pool
            const departmentPool = totals.localShare + totals.churchFundAmount;
            document.getElementById('departmentPoolTotal').textContent = formatCurrency(departmentPool);
            
            const tbody = document.getElementById('departmentBody');
            tbody.innerHTML = departments.map(dept => {
                const allocated = departmentPool * dept.percentage;
                
                // All expenses for this department (cumulative across all months)
                const allTimeSpent = churchData.expenses
                    .filter(e => e.department === dept.name)
                    .reduce((sum, e) => sum + e.amount, 0);
                
                // Current month expenses only
                const currentMonthSpent = churchData.expenses
                    .filter(e => e.department === dept.name && e.date.substring(0, 7) === churchData.currentMonth)
                    .reduce((sum, e) => sum + e.amount, 0);
                
                // Initialize cumulative balance if not exists
                if (!churchData.cumulativeDepartmentBalances[dept.name]) {
                    churchData.cumulativeDepartmentBalances[dept.name] = 0;
                }
                
                // Get cumulative balance
                let cumulativeBalance = churchData.cumulativeDepartmentBalances[dept.name];
                // Add current period allocation minus spent
                cumulativeBalance = cumulativeBalance + allocated - currentMonthSpent;
                
                return `
                    <tr>
                        <td>${dept.name}</td>
                        <td>${(dept.percentage * 100).toFixed(0)}%</td>
                        <td class="currency">${formatCurrency(allocated)}</td>
                        <td class="currency">${formatCurrency(allTimeSpent)}</td>
                        <td class="currency ${cumulativeBalance >= 0 ? 'balance-positive' : 'balance-negative'}">
                            ${formatCurrency(cumulativeBalance)}
                        </td>
                        <td>
                            <button class="btn btn-primary" onclick="openExpenseModal('${dept.name}')">
                                ‚ûï Add Expense
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Render monthly TAM/YAC records
            renderMonthlyTAMYAC();
        }

        // Render monthly TAM and YAC records
        function renderMonthlyTAMYAC() {
            const tbody = document.getElementById('monthlyTAMYACBody');
            
            if (churchData.monthlyTAMYAC.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #999;">No monthly records yet. Complete a month and start a new one to see records.</td></tr>';
                return;
            }
            
            tbody.innerHTML = churchData.monthlyTAMYAC.map(record => `
                <tr style="border-bottom: 1px solid #e5e7eb;">
                    <td style="padding: 12px;">${record.month}</td>
                    <td style="padding: 12px; text-align: right;">${formatCurrency(record.tamShare)}</td>
                    <td style="padding: 12px; text-align: right;">${formatCurrency(record.yacShare)}</td>
                    <td style="padding: 12px; text-align: right;">${formatCurrency(record.designatedTotal)}</td>
                </tr>
            `).join('');
        }

        // Render expenses
        function renderExpenses() {
            const tbody = document.getElementById('expenseBody');
            let expenses = churchData.expenses.filter(e => 
                e.date.substring(0, 7) === churchData.currentMonth
            );
            
            // Apply filters
            const deptFilter = document.getElementById('expenseFilterDept').value;
            const fromDate = document.getElementById('expenseFilterFrom').value;
            const toDate = document.getElementById('expenseFilterTo').value;
            
            if (deptFilter) {
                expenses = expenses.filter(e => e.department === deptFilter);
            }
            if (fromDate) {
                expenses = expenses.filter(e => e.date >= fromDate);
            }
            if (toDate) {
                expenses = expenses.filter(e => e.date <= toDate);
            }
            
            expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (expenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No expenses found</td></tr>';
                return;
            }
            
            tbody.innerHTML = expenses.map(exp => `
                <tr>
                    <td>${exp.date}</td>
                    <td>${exp.department}</td>
                    <td>${exp.description}</td>
                    <td class="currency">${formatCurrency(exp.amount)}</td>
                    <td>${exp.type}</td>
                    <td>${exp.reference}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteExpense('${exp.id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        // Render YAC designated funds
        function renderYACFunds() {
            const currentEntries = churchData.weeklyEntries.filter(e => 
                e.date.substring(0, 7) === churchData.currentMonth
            );
            
            const tbody = document.getElementById('yacBody');
            const categoryMap = {
                "Children's SS Project": 'childrenSS',
                "AY Project Offering": 'ayProject',
                "Church Expense (Designated)": 'churchExpense',
                "Potluck Donation": 'potluck',
                "Other Donation": 'other',
                "Children's Division Outreach Donation": 'childrenOutreach',
                "AY Outreach Donation": 'ayOutreach',
                "Church Fund": 'churchFund',
                "Church Community Donation": 'churchCommunity'
            };
            
            let totalIncome = 0;
            let totalExpenses = 0;
            
            tbody.innerHTML = designatedCategories.map(category => {
                const key = categoryMap[category];
                const income = currentEntries.reduce((sum, e) => sum + e.designatedOfferings[key], 0);
                const expenses = churchData.expenses
                    .filter(e => e.department === category && e.date.substring(0, 7) === churchData.currentMonth)
                    .reduce((sum, e) => sum + e.amount, 0);
                const balance = income - expenses;
                
                totalIncome += income;
                totalExpenses += expenses;
                
                return `
                    <tr>
                        <td>${category}</td>
                        <td class="currency">${formatCurrency(income)}</td>
                        <td class="currency">${formatCurrency(expenses)}</td>
                        <td class="currency ${balance >= 0 ? 'balance-positive' : 'balance-negative'}">
                            ${formatCurrency(balance)}
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('totalDesignatedIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('totalDesignatedExpenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('totalDesignatedBalance').textContent = formatCurrency(totalIncome - totalExpenses);
        }

        // Render monthly report
        function renderReport() {
            const totals = calculateTotals();
            
            // Render member collections table
            const collectionsBody = document.getElementById('memberCollectionsBody');
            const currentEntries = totals.currentEntries.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (currentEntries.length === 0) {
                collectionsBody.innerHTML = '<tr><td colspan="10" class="empty-state">No collections for this month</td></tr>';
            } else {
                const weeklyGroups = {};

                currentEntries.forEach(entry => {
                    const weekNumber = getWeekNumberForMonth(entry.date, churchData.currentMonth);
                    const key = String(weekNumber);
                    if (!weeklyGroups[key]) {
                        weeklyGroups[key] = {
                            weekNumber: weekNumber,
                            entries: []
                        };
                    }
                    weeklyGroups[key].entries.push(entry);
                });

                const weekKeys = Object.keys(weeklyGroups).sort((a, b) => Number(a) - Number(b));
                const rows = [];

                weekKeys.forEach(weekKey => {
                    const group = weeklyGroups[weekKey];
                    group.entries.sort((a, b) => new Date(a.date) - new Date(b.date));

                    rows.push(`
                        <tr style="background: #eef2ff; font-weight: bold;">
                            <td colspan="10">Week ${group.weekNumber}</td>
                        </tr>
                    `);

                    let weekTotalReceived = 0;
                    let weekTotalMission = 0;
                    let weekTithe = 0;
                    let weekTamShare = 0;
                    let weekTotalChurch = 0;
                    let weekYacShare = 0;
                    let weekTotalDonations = 0;

                    group.entries.forEach(entry => {
                        const sharedTotal = Object.values(entry.sharedOfferings).reduce((a, b) => a + b, 0);
                        const designatedTotal = Object.values(entry.designatedOfferings).reduce((a, b) => a + b, 0);
                        const tamShare = sharedTotal * 0.55; // 55% of shared
                        const yacShare = sharedTotal * 0.45; // 45% of shared
                        
                        // Total Mission Funds = Tithes + TAM Share (55% of shared)
                        const totalMissionFunds = entry.tithes + tamShare;
                        // Total Church Funds = YAC Share (45% of shared) + Designated
                        const totalChurchFunds = yacShare + designatedTotal;
                        // Total Received = Mission + Church
                        const totalReceived = totalMissionFunds + totalChurchFunds;

                        weekTotalReceived += totalReceived;
                        weekTotalMission += totalMissionFunds;
                        weekTithe += entry.tithes;
                        weekTamShare += tamShare;
                        weekTotalChurch += totalChurchFunds;
                        weekYacShare += yacShare;
                        weekTotalDonations += designatedTotal;

                        rows.push(`
                            <tr>
                                <td>${entry.date}</td>
                                <td>${entry.memberName}</td>
                                <td class="receipt-num">${entry.receiptNumber}</td>
                                <td class="currency"><strong>${formatCurrency(totalReceived)}</strong></td>
                                <td class="currency">${formatCurrency(totalMissionFunds)}</td>
                                <td class="currency">${formatCurrency(entry.tithes)}</td>
                                <td class="currency">${formatCurrency(tamShare)}</td>
                                <td class="currency">${formatCurrency(totalChurchFunds)}</td>
                                <td class="currency">${formatCurrency(yacShare)}</td>
                                <td class="currency">${formatCurrency(designatedTotal)}</td>
                            </tr>
                        `);
                    });

                    rows.push(`
                        <tr style="background: #f8f9fa; font-weight: bold; border-top: 2px solid #dee2e6;">
                            <td colspan="3">Weekly Total</td>
                            <td class="currency">${formatCurrency(weekTotalReceived)}</td>
                            <td class="currency">${formatCurrency(weekTotalMission)}</td>
                            <td class="currency">${formatCurrency(weekTithe)}</td>
                            <td class="currency">${formatCurrency(weekTamShare)}</td>
                            <td class="currency">${formatCurrency(weekTotalChurch)}</td>
                            <td class="currency">${formatCurrency(weekYacShare)}</td>
                            <td class="currency">${formatCurrency(weekTotalDonations)}</td>
                        </tr>
                    `);
                });

                const totalTithes = currentEntries.reduce((sum, e) => sum + e.tithes, 0);
                const totalShared = currentEntries.reduce((sum, e) => {
                    return sum + Object.values(e.sharedOfferings).reduce((a, b) => a + b, 0);
                }, 0);
                const totalDesignated = currentEntries.reduce((sum, e) => {
                    return sum + Object.values(e.designatedOfferings).reduce((a, b) => a + b, 0);
                }, 0);
                
                const grandTamShare = totalShared * 0.55; // 55% of shared
                const grandYacShare = totalShared * 0.45; // 45% of shared
                const grandTotalMission = totalTithes + grandTamShare; // Tithes + TAM Share
                const grandTotalChurch = grandYacShare + totalDesignated; // YAC Share + Designated
                const grandTotal = grandTotalMission + grandTotalChurch;

                rows.push(`
                    <tr style="background: #f0f0f0; font-weight: bold; border-top: 3px solid #667eea;">
                        <td colspan="3"><strong>GRAND TOTALS</strong></td>
                        <td class="currency">${formatCurrency(grandTotal)}</td>
                        <td class="currency">${formatCurrency(grandTotalMission)}</td>
                        <td class="currency">${formatCurrency(totalTithes)}</td>
                        <td class="currency">${formatCurrency(grandTamShare)}</td>
                        <td class="currency">${formatCurrency(grandTotalChurch)}</td>
                        <td class="currency">${formatCurrency(grandYacShare)}</td>
                        <td class="currency">${formatCurrency(totalDesignated)}</td>
                    </tr>
                `);

                collectionsBody.innerHTML = rows.join('');
            }
            
            // Calculate and display totals with new terminology
            const totalMissionFunds = totals.totalTithes + totals.missionShare; // Tithes + 55% shared
            const totalChurchFunds = totals.localShare + totals.totalDesignated; // 45% shared + designated
            const totalReceived = totalMissionFunds + totalChurchFunds;
            
            document.getElementById('tamShareAmount').textContent = formatCurrency(totalMissionFunds);
            document.getElementById('yacShareAmount').textContent = formatCurrency(totalChurchFunds);
            document.getElementById('totalCollectionsAmount').textContent = formatCurrency(totalReceived);
        }



        // Render all views
        function renderAllViews() {
            renderEntries();
            renderDepartments();
            renderExpenses();
            renderYACFunds();
            renderReport();
            updateMemberList();
            renderMembers();
            renderArchives();
            renderUsers();
            renderAuditLog();
        }

        // New month function
        function newMonth() {
            if (confirm('This will archive current month data and start a new month. Continue?')) {
                // Calculate totals for current month before archiving
                const totals = calculateTotals();
                const tamShare = totals.totalTithes + totals.missionShare;
                const yacShare = totals.localShare;
                
                // Department pool includes 45% local share + Church Fund
                const departmentPool = totals.localShare + totals.churchFundAmount;
                
                // Update cumulative department balances
                departments.forEach(dept => {
                    const allocated = departmentPool * dept.percentage;
                    const spent = churchData.expenses
                        .filter(e => e.department === dept.name && e.date.substring(0, 7) === churchData.currentMonth)
                        .reduce((sum, e) => sum + e.amount, 0);
                    
                    if (!churchData.cumulativeDepartmentBalances[dept.name]) {
                        churchData.cumulativeDepartmentBalances[dept.name] = 0;
                    }
                    churchData.cumulativeDepartmentBalances[dept.name] += allocated - spent;
                });
                
                // Record month's TAM and YAC values
                churchData.monthlyTAMYAC.push({
                    month: churchData.currentMonth,
                    tamShare: tamShare,
                    yacShare: yacShare,
                    designatedTotal: totals.totalDesignated
                });
                
                // Archive current month
                churchData.monthlyArchives.push({
                    month: churchData.currentMonth,
                    entries: [...churchData.weeklyEntries],
                    expenses: [...churchData.expenses]
                });
                
                // Clear current data (but NEVER clear members)
                churchData.weeklyEntries = [];
                churchData.expenses = [];
                // CRITICAL: Members are preserved permanently across all months
                if (!churchData.members) {
                    churchData.members = [];
                }
                
                // Set next month
                const current = new Date(churchData.currentMonth + '-01');
                const oldMonth = churchData.currentMonth;
                current.setMonth(current.getMonth() + 1);
                churchData.currentMonth = current.toISOString().substring(0, 7);
                document.getElementById('monthSelector').value = churchData.currentMonth;
                
                addAuditLog(`Created new month: Archived ${oldMonth} and started ${churchData.currentMonth}`);
                
                // Beginning balance becomes ending balance of previous month
                // This can be manually adjusted in the report
                
                saveData(true);
                renderAllViews();
                alert('‚úÖ New month started!');
            }
        }

        // Month selector change - preserves all member data
        document.getElementById('monthSelector').addEventListener('change', function() {
            const memberBackup = [...churchData.members]; // Backup members
            
            churchData.currentMonth = this.value;
            
            // CRITICAL: Restore members after changing month
            churchData.members = memberBackup;
            
            saveData(true);
            renderAllViews();
        });

        // Download Full Data Backup as JSON
        function downloadBackup() {
            const backupData = {
                timestamp: new Date().toISOString(),
                appVersion: '1.0',
                data: churchData,
                users: systemUsers
            };
            
            const fileName = `church-backup-${new Date().toISOString().split('T')[0]}.json`;
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alert(`Backup saved as ${fileName}`);
        }

        // Upload Full Data Backup from JSON
        function uploadBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const backupData = JSON.parse(event.target.result);
                        
                        if (!backupData.data || !backupData.data.weeklyEntries) {
                            alert('Invalid backup file format');
                            return;
                        }
                        
                        if (confirm('This will replace all current data. Are you sure?')) {
                            churchData = normalizeChurchData(backupData.data);
                            if (backupData.users && Array.isArray(backupData.users)) {
                                systemUsers = backupData.users;
                                localStorage.setItem('systemUsers', JSON.stringify(systemUsers));
                            }
                            localStorage.setItem('churchFinancialData', JSON.stringify(churchData));
                            addAuditLog(`Restored backup from ${file.name}`);
                            renderAllViews();
                            alert('Backup restored successfully!');
                        }
                    } catch (error) {
                        alert('Error reading backup file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Export to CSV
        function exportToCSV() {
            const totals = calculateTotals();
            const currentEntries = totals.currentEntries.sort((a, b) => new Date(a.date) - new Date(b.date));
            const reportLogoPath = './assets/report-logo.png';
            
            let csv = `Church Financial Report - ${churchData.churchName}\n`;
            csv += `Logo: ${reportLogoPath}\n`;
            csv += `Month: ${churchData.currentMonth}\n\n`;
            
            csv += `WEEKLY COLLECTIONS BY MEMBER\n`;
            csv += `Date,Receipt #,Member Name,Tithes,Shared Offerings,Designated,Total\n`;

            if (currentEntries.length > 0) {
                const weeklyGroups = {};

                currentEntries.forEach(entry => {
                    const weekNumber = getWeekNumberForMonth(entry.date, churchData.currentMonth);
                    const key = String(weekNumber);
                    if (!weeklyGroups[key]) {
                        weeklyGroups[key] = {
                            weekNumber: weekNumber,
                            entries: []
                        };
                    }
                    weeklyGroups[key].entries.push(entry);
                });

                const weekKeys = Object.keys(weeklyGroups).sort((a, b) => Number(a) - Number(b));

                weekKeys.forEach(weekKey => {
                    const group = weeklyGroups[weekKey];
                    group.entries.sort((a, b) => new Date(a.date) - new Date(b.date));
                    csv += `Week ${group.weekNumber}\n`;

                    let weekTithes = 0;
                    let weekShared = 0;
                    let weekDesignated = 0;

                    group.entries.forEach(entry => {
                        const sharedTotal = Object.values(entry.sharedOfferings).reduce((a, b) => a + b, 0);
                        const designatedTotal = Object.values(entry.designatedOfferings).reduce((a, b) => a + b, 0);
                        const grandTotal = entry.tithes + sharedTotal + designatedTotal;

                        weekTithes += entry.tithes;
                        weekShared += sharedTotal;
                        weekDesignated += designatedTotal;

                        csv += `${entry.date},${entry.receiptNumber},${entry.memberName},${entry.tithes.toFixed(2)},${sharedTotal.toFixed(2)},${designatedTotal.toFixed(2)},${grandTotal.toFixed(2)}\n`;
                    });

                    const weekTotal = weekTithes + weekShared + weekDesignated;
                    csv += `Weekly Total,,,${weekTithes.toFixed(2)},${weekShared.toFixed(2)},${weekDesignated.toFixed(2)},${weekTotal.toFixed(2)}\n\n`;
                });
            }
            
            csv += `\n`;
            const tamShare = totals.totalTithes + totals.missionShare;
            const yacShare = totals.localShare;
            const designatedTotal = totals.totalDesignated;
            
            csv += `SUMMARY\n`;
            csv += `TAM Share (To Mission),${tamShare.toFixed(2)}\n`;
            csv += `YAC Share (Local Church),${yacShare.toFixed(2)}\n`;
            csv += `Designated (100% to YAC),${designatedTotal.toFixed(2)}\n`;
            csv += `Total Collections,${totals.totalReceipts.toFixed(2)}\n`;
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `church-report-${churchData.currentMonth}.csv`;
            a.click();
        }

        // Export to PDF (using print)
        function exportToPDF() {
            window.print();
        }

        // Members Management Functions
        function addMember(event) {
            event.preventDefault();
            const memberName = document.getElementById('newMemberName').value.trim();
            
            if (!memberName) {
                alert('Please enter a member name');
                return;
            }
            
            // Check if member already exists
            if (churchData.members.includes(memberName)) {
                alert('This member already exists!');
                return;
            }
            
            churchData.members.push(memberName);
            churchData.members.sort(); // Keep alphabetically sorted
            addAuditLog(`Added member: ${memberName}`);
            saveData(true);
            
            document.getElementById('memberForm').reset();
            updateMemberList();
            renderMembers();
            alert('‚úÖ Member added successfully!');
        }

        function deleteMember(memberName) {
            if (confirm(`Are you sure you want to remove "${memberName}" from the member list?`)) {
                churchData.members = churchData.members.filter(m => m !== memberName);
                addAuditLog(`Deleted member: ${memberName}`);
                saveData(true);
                updateMemberList();
                renderMembers();
                alert('‚úÖ Member removed successfully!');
            }
        }

        function updateMemberList() {
            const datalist = document.getElementById('memberList');
            if (!datalist) {
                return;
            }

            if (!Array.isArray(churchData.members)) {
                churchData.members = [];
            }
            datalist.innerHTML = '';
            
            churchData.members.forEach(member => {
                const option = document.createElement('option');
                option.value = member;
                datalist.appendChild(option);
            });
        }

        function renderMembers() {
            const container = document.getElementById('membersList');
            const heading = document.getElementById('memberCountHeading');
            
            // Update member count in heading
            if (heading) {
                heading.textContent = `Member List (${churchData.members.length} members)`;
            }
            
            if (churchData.members.length === 0) {
                container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;">No members added yet</div>';
                return;
            }
            
            container.innerHTML = churchData.members.map(member => {
                const escapedMember = member.replace(/'/g, "\\'");
                return `
                    <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #667eea;">
                        <span style="font-weight: 500;">${member}</span>
                        <button class="btn btn-danger" onclick="deleteMember('${escapedMember}')">üóëÔ∏è</button>
                    </div>
                `;
            }).join('');
        }

        // Render archives list
        function renderArchives() {
            const container = document.getElementById('archivesList');
            
            if (churchData.monthlyArchives.length === 0) {
                container.innerHTML = '<div class="empty-state"><div>üìö</div><p>No archived months yet. Start a new month to create an archive.</p></div>';
                return;
            }
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
                    ${churchData.monthlyArchives.map((archive, index) => {
                        const totalCollection = archive.entries.reduce((sum, e) => {
                            return sum + e.tithes + 
                                   (e.sharedOfferings.oneFund + e.sharedOfferings.special + 
                                    e.sharedOfferings.churchOffering + e.sharedOfferings.sabbathSchool) +
                                   (e.designatedOfferings.childrenSS + e.designatedOfferings.ayProject + 
                                    e.designatedOfferings.churchExpense + e.designatedOfferings.potluck + 
                                    e.designatedOfferings.other + e.designatedOfferings.childrenOutreach +
                                    e.designatedOfferings.ayOutreach + e.designatedOfferings.churchFund +
                                    e.designatedOfferings.churchCommunity);
                        }, 0);
                        
                        return `
                            <div class="archive-item" onclick="viewArchiveDetail(${index})">
                                <h4>${archive.month}</h4>
                                <p>Entries: ${archive.entries.length}</p>
                                <p>Total Collection: ${formatCurrency(totalCollection)}</p>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // View archive detail
        function viewArchiveDetail(index) {
            const archive = churchData.monthlyArchives[index];
            const modal = document.getElementById('archiveDetailModal');
            const title = document.getElementById('archiveDetailTitle');
            const content = document.getElementById('archiveDetailContent');
            
            title.textContent = `Archive Details - ${archive.month}`;
            
            // Calculate totals for this archive
            let totalTithes = 0, totalShared = 0, totalDesignated = 0;
            
            archive.entries.forEach(e => {
                totalTithes += e.tithes;
                totalShared += e.sharedOfferings.oneFund + e.sharedOfferings.special + 
                              e.sharedOfferings.churchOffering + e.sharedOfferings.sabbathSchool;
                totalDesignated += e.designatedOfferings.childrenSS + e.designatedOfferings.ayProject + 
                                  e.designatedOfferings.churchExpense + e.designatedOfferings.potluck + 
                                  e.designatedOfferings.other + e.designatedOfferings.childrenOutreach +
                                  e.designatedOfferings.ayOutreach + e.designatedOfferings.churchFund +
                                  e.designatedOfferings.churchCommunity;
            });
            
            const missionShare = totalShared * 0.55;
            const localShare = totalShared * 0.45;
            const totalCollection = totalTithes + totalShared + totalDesignated;
            const tamShare = totalTithes + missionShare;
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                    <div style="background: #f0f4ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                        <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">TAM SHARE</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #667eea;">‡∏ø${formatCurrency(tamShare).replace('‡∏ø', '')}</div>
                    </div>
                    <div style="background: #f0fef0; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
                        <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">YAC SHARE</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #10b981;">‡∏ø${formatCurrency(localShare).replace('‡∏ø', '')}</div>
                    </div>
                    <div style="background: #fff5f0; padding: 15px; border-radius: 8px; border-left: 4px solid #f97316;">
                        <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">DESIGNATED</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #f97316;">‡∏ø${formatCurrency(totalDesignated).replace('‡∏ø', '')}</div>
                    </div>
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; border-left: 4px solid #1f2937;">
                        <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">TOTAL COLLECTIONS</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #1f2937;">‡∏ø${formatCurrency(totalCollection).replace('‡∏ø', '')}</div>
                    </div>
                </div>
                
                <h3>Entries (${archive.entries.length})</h3>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                    <thead>
                        <tr style="background: #f3f4f6;">
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #d1d5db;">Date</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #d1d5db;">Receipt #</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #d1d5db;">Member</th>
                            <th style="padding: 10px; text-align: right; border-bottom: 2px solid #d1d5db;">Tithes</th>
                            <th style="padding: 10px; text-align: right; border-bottom: 2px solid #d1d5db;">Shared</th>
                            <th style="padding: 10px; text-align: right; border-bottom: 2px solid #d1d5db;">Designated</th>
                            <th style="padding: 10px; text-align: right; border-bottom: 2px solid #d1d5db;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${archive.entries.map(e => {
                            const sharedTotal = e.sharedOfferings.oneFund + e.sharedOfferings.special + 
                                              e.sharedOfferings.churchOffering + e.sharedOfferings.sabbathSchool;
                            const designatedTotal = e.designatedOfferings.childrenSS + e.designatedOfferings.ayProject + 
                                                  e.designatedOfferings.churchExpense + e.designatedOfferings.potluck + 
                                                  e.designatedOfferings.other + e.designatedOfferings.childrenOutreach +
                                                  e.designatedOfferings.ayOutreach + e.designatedOfferings.churchFund +
                                                  e.designatedOfferings.churchCommunity;
                            const entryTotal = e.tithes + sharedTotal + designatedTotal;
                            
                            return `
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 10px;">${e.date}</td>
                                    <td style="padding: 10px;">${e.receiptNumber}</td>
                                    <td style="padding: 10px;">${e.memberName}</td>
                                    <td style="padding: 10px; text-align: right;">‡∏ø${formatCurrency(e.tithes).replace('‡∏ø', '')}</td>
                                    <td style="padding: 10px; text-align: right;">‡∏ø${formatCurrency(sharedTotal).replace('‡∏ø', '')}</td>
                                    <td style="padding: 10px; text-align: right;">‡∏ø${formatCurrency(designatedTotal).replace('‡∏ø', '')}</td>
                                    <td style="padding: 10px; text-align: right; font-weight: bold;">‡∏ø${formatCurrency(entryTotal).replace('‡∏ø', '')}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                
                <h3>Expenses (${archive.expenses.length})</h3>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f3f4f6;">
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #d1d5db;">Date</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #d1d5db;">Department</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #d1d5db;">Description</th>
                            <th style="padding: 10px; text-align: right; border-bottom: 2px solid #d1d5db;">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${archive.expenses.length === 0 ? '<tr><td colspan="4" style="padding: 10px; text-align: center; color: #999;">No expenses recorded</td></tr>' : 
                          archive.expenses.map(e => `
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 10px;">${e.date}</td>
                                <td style="padding: 10px;">${e.department}</td>
                                <td style="padding: 10px;">${e.description}</td>
                                <td style="padding: 10px; text-align: right;">‡∏ø${formatCurrency(e.amount).replace('‡∏ø', '')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            content.innerHTML = html;
            modal.style.display = 'block';
            
            // Store current archive index for export
            window.currentArchiveIndex = index;
        }

        // Edit archived month - preserves all member data
        function editArchivedMonth(index) {
            const archive = churchData.monthlyArchives[index];
            const memberBackup = [...churchData.members]; // Backup current members
            
            // Load archive data into current working environment
            churchData.currentMonth = archive.month;
            churchData.weeklyEntries = JSON.parse(JSON.stringify(archive.entries));
            churchData.expenses = JSON.parse(JSON.stringify(archive.expenses));
            
            // CRITICAL: Restore members to ensure they're never lost
            churchData.members = memberBackup;
            
            // Update month selector
            document.getElementById('monthSelector').value = archive.month;
            
            addAuditLog(`Opened archived month for editing: ${archive.month}`);
            
            // Save the changes
            saveData(true);
            
            // Close archive modal
            closeArchiveDetail();
            
            // Render all views
            renderAllViews();
            
            // Switch to Data Entry tab
            switchTab(0);
            
            alert(`üìù Now editing archive for ${archive.month}. All member data is preserved.`);
        }

        // Close archive detail modal
        function closeArchiveDetail() {
            const modal = document.getElementById('archiveDetailModal');
            modal.style.display = 'none';
        }

        // Export archive as CSV
        function exportArchiveCSV() {
            const index = window.currentArchiveIndex;
            const archive = churchData.monthlyArchives[index];
            let csv = `Church Financial Report - ${archive.month}\n\n`;
            
            // Summary section
            csv += `Summary\n`;
            let totalTithes = 0, totalShared = 0, totalDesignated = 0;
            
            archive.entries.forEach(e => {
                totalTithes += e.tithes;
                totalShared += e.sharedOfferings.oneFund + e.sharedOfferings.special + 
                              e.sharedOfferings.churchOffering + e.sharedOfferings.sabbathSchool;
                totalDesignated += e.designatedOfferings.childrenSS + e.designatedOfferings.ayProject + 
                                  e.designatedOfferings.churchExpense + e.designatedOfferings.potluck + 
                                  e.designatedOfferings.other + e.designatedOfferings.childrenOutreach +
                                  e.designatedOfferings.ayOutreach + e.designatedOfferings.churchFund +
                                  e.designatedOfferings.churchCommunity;
            });
            
            const missionShare = totalShared * 0.55;
            const localShare = totalShared * 0.45;
            const totalCollection = totalTithes + totalShared + totalDesignated;
            const tamShare = totalTithes + missionShare;
            
            csv += `TAM Share,‡∏ø${totalTithes + missionShare}\n`;
            csv += `YAC Share,‡∏ø${localShare}\n`;
            csv += `Designated,‡∏ø${totalDesignated}\n`;
            csv += `Total Collections,‡∏ø${totalCollection}\n\n`;
            
            // Entries section
            csv += `Entries\nDate,Receipt #,Member,Tithes,One Fund,Special,Church Offering,Sabbath School,Children SS,AY Project,Church Expense,Potluck,Other,Children Outreach,AY Outreach,Church Fund,Church Community\n`;
            archive.entries.forEach(e => {
                csv += `${e.date},${e.receiptNumber},${e.memberName},${e.tithes},${e.sharedOfferings.oneFund},${e.sharedOfferings.special},${e.sharedOfferings.churchOffering},${e.sharedOfferings.sabbathSchool},${e.designatedOfferings.childrenSS},${e.designatedOfferings.ayProject},${e.designatedOfferings.churchExpense},${e.designatedOfferings.potluck},${e.designatedOfferings.other},${e.designatedOfferings.childrenOutreach},${e.designatedOfferings.ayOutreach},${e.designatedOfferings.churchFund},${e.designatedOfferings.churchCommunity}\n`;
            });
            
            csv += `\nExpenses\nDate,Department,Description,Amount\n`;
            archive.expenses.forEach(e => {
                csv += `${e.date},${e.department},${e.description},${e.amount}\n`;
            });
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Church-Financial-Report-${archive.month}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const expenseModal = document.getElementById('expenseModal');
            const changePasswordModal = document.getElementById('changePasswordModal');
            const archiveModal = document.getElementById('archiveDetailModal');
            
            if (event.target === expenseModal) {
                closeModal();
            }
            if (event.target === changePasswordModal) {
                closeChangePasswordModal();
            }
            if (event.target === archiveModal) {
                closeArchiveDetail();
            }
        }

        // Initialize on load
        window.addEventListener('load', initializeAuthSystem);

        // Auto-save every 5 minutes
        setInterval(saveData, 300000);
    </script>
</body>
</html>
